<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24ç‚¹å¡ç‰Œæ¸¸æˆ - æ±ªçªå‡¯çš„å­¦ä¹ å¤©åœ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js" defer></script>
    <style>
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }

        .card {
            width: 120px;
            height: 180px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        
        .card.selected {
            transform: translateY(-12px) scale(1.1);
            box-shadow: 0 12px 32px rgba(74, 144, 226, 0.4);
            border: 3px solid #4A90E2;
        }
        
        /* æ–°å¢ï¼šå·²ä½¿ç”¨å¡ç‰Œæ ·å¼ */
        .card.used {
            filter: grayscale(1);
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-color: #ddd;
        }
        .card.used:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .card-number {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            line-height: 1;
        }
        
        .card-suit {
            font-size: 2rem;
            text-align: center;
        }
        
        .red {
            color: #DC2626;
        }
        
        .black {
            color: #1F2937;
        }
        
        .mode-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mode-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .mode-card.selected {
            border: 3px solid #4A90E2;
            background: #EBF4FF;
        }
        
        .timer-circle {
            transform: rotate(-90deg);
        }
        
        .timer-progress {
            transition: stroke-dashoffset 1s linear;
        }
        
        .expression-input {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body class="tw-theme bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                        â† è¿”å›
                    </button>
                    <h1 class="text-2xl font-bold text-gray-800">24ç‚¹å¡ç‰Œæ¸¸æˆ</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        ä»Šæ—¥å¾—åˆ†: <span class="font-bold text-blue-600" id="today-score">0</span>
                    </div>
                    <button onclick="goHome()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹© -->
        <div class="mb-8" id="mode-selection">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <!-- ç»ƒä¹ æ¨¡å¼ -->
                <div class="mode-card bg-white rounded-2xl p-6 shadow-lg" onclick="selectMode('practice')">
                    <div class="text-center">
                        <div class="text-6xl mb-4">ğŸ®</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">ç»ƒä¹ æ¨¡å¼</h3>
                        <p class="text-gray-600 mb-4">æ— æ—¶é—´é™åˆ¶ï¼Œè‡ªç”±ç»ƒä¹ <br>å¯ä»¥åå¤åˆ·æ–°é¢˜ç›®</p>
                        <div class="text-sm text-blue-600 font-medium">é€‚åˆç†Ÿæ‚‰æ¸¸æˆè§„åˆ™</div>
                    </div>
                </div>
                
                <!-- æ‰“å¡æ¨¡å¼ -->
                <div class="mode-card bg-white rounded-2xl p-6 shadow-lg" onclick="selectMode('checkin')">
                    <div class="text-center">
                        <div class="text-6xl mb-4">â°</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">æ‰“å¡æ¨¡å¼</h3>
                        <p class="text-gray-600 mb-4">æ¯é¢˜40ç§’å€’è®¡æ—¶<br>å®Œæˆ50é¢˜å³å¯æ‰“å¡</p>
                        <div class="text-sm text-orange-600 font-medium">æŒ‘æˆ˜è‡ªæˆ‘æé™</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div class="hidden" id="game-interface">
            <!-- æ¸¸æˆçŠ¶æ€æ ï¼ˆåˆå¹¶åˆ°ä¸‹æ–¹ç»Ÿè®¡ï¼Œéšè—æ­¤æ¨¡å—ï¼‰ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6" style="display:none;">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="current-score">0</div>
                            <div class="text-sm text-gray-500">å½“å‰å¾—åˆ†</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="correct-count">0</div>
                            <div class="text-sm text-gray-500">ç­”å¯¹é¢˜æ•°</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" id="total-questions">0</div>
                            <div class="text-sm text-gray-500">æ€»é¢˜æ•°</div>
                        </div>
                    </div>
                    <!-- å€’è®¡æ—¶å™¨ä¿ç•™ä½†æ•´ä½“éšè— -->
                    <div class="text-center" id="timer-container" style="display: none;">
                        <div class="relative w-16 h-16">
                            <svg class="timer-circle w-16 h-16" viewBox="0 0 36 36">
                                <path class="timer-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                      fill="none" stroke="#E5E7EB" stroke-width="3"/>
                                <path class="timer-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                      fill="none" stroke="#EF4444" stroke-width="3" stroke-dasharray="100, 100" stroke-dashoffset="0"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-lg font-bold text-red-600" id="timer-text">10:00</span>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 mt-1">å‰©ä½™æ—¶é—´</div>
                    </div>
                </div>
            </div>

            <!-- å¡ç‰ŒåŒºåŸŸ -->
            <div id="top-row" class="md:flex md:space-x-6 mb-4">
                <div class="md:flex-1 bg-white rounded-2xl shadow-lg p-6 mb-4">
                    <div class="flex justify-center items-center space-x-6 mb-4" id="cards-container">
                        <!-- å¡ç‰Œå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex justify-center space-x-4 mb-6">
                        <button onclick="generateNewCards()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            åˆ·æ–°é¢˜ç›®
                        </button>
                        <button onclick="showHint()" class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium">
                            æç¤º
                        </button>
                        <button onclick="clearExpression()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                            æ¸…é™¤
                        </button>
                    </div>
                </div>
                <div id="stats-slot" class="md:w-1/3 mt-6 md:mt-0"></div>
            </div>

            <!-- è¡¨è¾¾å¼è¾“å…¥åŒºåŸŸ -->
            <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-3">è¾“å…¥ä½ çš„ç­”æ¡ˆ</h3>
                <div class="expression-input bg-gray-50 rounded-lg p-4 mb-4 min-h-16 flex items-center justify-center text-center" id="expression-display">
                    ç‚¹å‡»æ•°å­—å’Œè¿ç®—ç¬¦æ„å»ºè¡¨è¾¾å¼
                </div>
                
                <!-- æ•°å­—ç”±å¡ç‰Œå¡«å…¥ï¼Œæ— ç‹¬ç«‹æ•°å­—æŒ‰é’® -->
                <div class="text-sm text-gray-500 text-center mb-4">æ•°å­—ç”±ç‚¹å‡»ä¸Šæ–¹å¡ç‰Œè‡ªåŠ¨å¡«å…¥</div>



                <!-- è¿ç®—ç¬¦æŒ‰é’® -->
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <button class="operator-btn bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-3 rounded-lg transition-colors" data-operator="+">+</button>
                    <button class="operator-btn bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-3 rounded-lg transition-colors" data-operator="-">-</button>
                    <button class="operator-btn bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-3 rounded-lg transition-colors" data-operator="*">Ã—</button>
                    <button class="operator-btn bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-3 rounded-lg transition-colors" data-operator="/">Ã·</button>
                    <button class="operator-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 rounded-lg transition-colors" data-operator="(">(</button>
                    <button class="operator-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 rounded-lg transition-colors" data-operator=")">)</button>
                    <button class="bg-red-100 hover:bg-red-200 text-red-800 font-bold py-3 rounded-lg transition-colors" onclick="deleteLastChar()">â†</button>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors" onclick="submitAnswer()">æäº¤</button>
                </div>
            </div>

            <!-- æç¤ºä¿¡æ¯ -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden" id="hint-panel">
                <div class="flex items-center">
                    <span class="text-yellow-600 mr-2">ğŸ’¡</span>
                    <div>
                        <div class="font-medium text-yellow-800">æç¤º</div>
                        <div class="text-yellow-700 text-sm" id="hint-text"></div>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆç»Ÿè®¡ -->
            <div id="stats-panel" class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">æ¸¸æˆç»Ÿè®¡</h3>
                    <!-- æœ¬é¢˜å€’è®¡æ—¶ï¼ˆä»…æ‰“å¡æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                    <div id="question-timer" class="flex items-center" style="display:none;">
                        <div class="text-center">
                            <div class="relative w-16 h-16 mx-auto">
                                <svg viewBox="0 0 36 36" class="w-16 h-16">
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                          fill="none" stroke="#E5E7EB" stroke-width="3" />
                                    <path id="question-timer-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                          fill="none" stroke="#F59E0B" stroke-width="3" stroke-dasharray="100,100" stroke-dashoffset="0" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-lg font-bold text-orange-600" id="question-timer-text">00:40</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">æœ¬é¢˜å‰©ä½™æ—¶é—´</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="current-score">0</div>
                        <div class="text-sm text-gray-500">å½“å‰å¾—åˆ†</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="correct-count">0</div>
                        <div class="text-sm text-gray-500">ç­”å¯¹é¢˜æ•°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600" id="total-questions">0</div>
                        <div class="text-sm text-gray-500">æ€»é¢˜æ•°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="success-rate">0%</div>
                        <div class="text-sm text-gray-500">æˆåŠŸç‡</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600" id="best-time">--:--</div>
                        <div class="text-sm text-gray-500">æœ€ä½³æ—¶é—´</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="total-practice">0</div>
                        <div class="text-sm text-gray-500">æ€»ç»ƒä¹ æ¬¡æ•°</div>
                    </div>
                </div>
                <!-- ä¿ç•™ä¸€ä¸ªéšå«å…ƒç´ ä»¥å…¼å®¹æ—§ç»Ÿè®¡ä»£ç ï¼ˆä¸å±•ç¤ºï¼‰ -->
                <div id="practice-score" class="hidden">0</div>
             </div>
        </div>
    </main>

    <!-- åº†ç¥åŠ¨ç”»å®¹å™¨ -->
    <div id="celebration-container"></div>

    <!-- ä¸­å¿ƒæç¤ºæ¡†è¦†ç›–å±‚ -->
    <div id="center-hint" class="fixed inset-0 flex items-center justify-center pointer-events-none z-50 hidden">
        <div id="center-hint-box" class="bg-yellow-50 border border-yellow-200 rounded-xl shadow-xl px-5 py-4 text-yellow-800">
            <div class="font-semibold mb-1">æç¤º</div>
            <div id="center-hint-text" class="text-sm"></div>
        </div>
    </div>

    <script>
        // 24ç‚¹æ¸¸æˆæ ¸å¿ƒé€»è¾‘
        let gameMode = '';
        let currentCards = [];
        let currentExpression = '';
        let gameStats = {
            score: 0,
            correctCount: 0,
            totalQuestions: 0,
            startTime: null,
            timeLeft: 600 // 10åˆ†é’Ÿ
        };
        let timerInterval = null;
        const QUESTION_TIME = 40; // æ¯é¢˜40ç§’
        let availableNumbers = [];
        let currentSolutionExpr = null; // ä¿å­˜å½“å‰é¢˜ç›®çš„ä¸€ä¸ªå¯è¡Œè§£è¡¨è¾¾å¼

        // å¡ç‰ŒèŠ±è‰²å’Œæ•°å€¼å®šä¹‰
        const suits = [
            { name: 'hearts', symbol: 'â™¥', color: 'red' },
            { name: 'diamonds', symbol: 'â™¦', color: 'red' },
            { name: 'clubs', symbol: 'â™£', color: 'black' },
            { name: 'spades', symbol: 'â™ ', color: 'black' }
        ];

        const cardValues = [
            { value: 1, display: 'A', realValue: 1 },
            { value: 2, display: '2', realValue: 2 },
            { value: 3, display: '3', realValue: 3 },
            { value: 4, display: '4', realValue: 4 },
            { value: 5, display: '5', realValue: 5 },
            { value: 6, display: '6', realValue: 6 },
            { value: 7, display: '7', realValue: 7 },
            { value: 8, display: '8', realValue: 8 },
            { value: 9, display: '9', realValue: 9 },
            { value: 10, display: '10', realValue: 10 },
            { value: 11, display: 'J', realValue: 10 },
            { value: 12, display: 'Q', realValue: 10 },
            { value: 13, display: 'K', realValue: 10 }
        ];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadGameStats();
            moveStatsToRight();
        });

        // å°†ç»Ÿè®¡é¢æ¿ç§»åŠ¨åˆ°å³ä¾§æ§½ä½
        function moveStatsToRight() {
            const slot = document.getElementById('stats-slot');
            const panel = document.getElementById('stats-panel');
            if (slot && panel) {
                slot.appendChild(panel);
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            document.querySelectorAll('.operator-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    addToExpression(this.dataset.operator);
                });
            });
        }

        // é€‰æ‹©æ¸¸æˆæ¨¡å¼
        function selectMode(mode) {
            gameMode = mode;
            
            // æ›´æ–°UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            setTimeout(() => {
                document.getElementById('mode-selection').style.display = 'none';
                document.getElementById('game-interface').classList.remove('hidden');
                
                // å¼€å§‹æ¸¸æˆ
                startGame();
            }, 500);
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            gameStats.startTime = Date.now();
            gameStats.score = 0;
            gameStats.correctCount = 0;
            gameStats.totalQuestions = 0;

            // ç»ƒä¹ æ¨¡å¼ä¸æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œæ‰“å¡æ¨¡å¼æ˜¾ç¤ºé¢˜ç›®è®¡æ—¶å™¨
            if (gameMode === 'checkin') {
                const qt = document.getElementById('question-timer');
                if (qt) qt.style.display = 'flex';
            }
            
            updateStats();
            generateNewCards();
            // æ‰“å¡æ¨¡å¼ä»ç¬¬ä¸€é¢˜å¼€å§‹è®¡æ—¶
            if (gameMode === 'checkin') startQuestionTimer();
        }

        // å¼€å§‹é¢˜ç›®çº§è®¡æ—¶å™¨ï¼ˆæ‰“å¡æ¨¡å¼ï¼‰
        function startQuestionTimer() {
            if (timerInterval) clearInterval(timerInterval);
            gameStats.timeLeft = QUESTION_TIME;
            updateTimer();
            timerInterval = setInterval(() => {
                gameStats.timeLeft--;
                updateTimer();
                if (gameStats.timeLeft <= 0) {
                    clearInterval(timerInterval);
                    onQuestionTimeout();
                }
            }, 1000);
        }

        // æœ¬é¢˜å€’è®¡æ—¶ç»“æŸå¤„ç†
        function onQuestionTimeout() {
            showMessage('æ—¶é—´åˆ°ï¼å·²åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜', 'error');
            setTimeout(() => {
                generateNewCards();
                if (gameMode === 'checkin') startQuestionTimer();
            }, 800);
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤ºï¼ˆé¢˜ç›®çº§ï¼Œæ€»æ—¶é•¿40ç§’ï¼‰
        function updateTimer() {
            const minutes = Math.floor(gameStats.timeLeft / 60);
            const seconds = gameStats.timeLeft % 60;
            const textEl = document.getElementById('question-timer-text');
            if (textEl) {
                textEl.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2, '0')}`;
            }
            const progress = (gameStats.timeLeft / QUESTION_TIME) * 100;
            const circumference = 2 * Math.PI * 15.9155;
            const offset = circumference - (progress / 100) * circumference;
            const progressEl = document.getElementById('question-timer-progress');
            if (progressEl) progressEl.style.strokeDashoffset = offset;
        }

        // ç”Ÿæˆæ–°å¡ç‰Œ
        function generateNewCards() {
            let cards = [];
            let hasSolution = false;
            
            // å¾ªç¯ç›´åˆ°æ‰¾åˆ°æœ‰è§£çš„ç‰Œç»„
            while (!hasSolution) {
                cards = [];
                for (let i = 0; i < 4; i++) {
                    const randomCard = cardValues[Math.floor(Math.random() * cardValues.length)];
                    const randomSuit = suits[Math.floor(Math.random() * suits.length)];
                    cards.push({
                        ...randomCard,
                        suit: randomSuit,
                        used: false
                    });
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è§£ï¼Œä¸”ä¿å­˜ä¸€ä¸ªè§£æ³•è¡¨è¾¾å¼
                hasSolution = check24PointSolution(cards.map(card => card.realValue));
            }
            
            currentCards = cards;
            availableNumbers = cards.map(card => card.realValue);
            renderCards();
            clearExpression();
            updateAvailableNumbers();
            
            gameStats.totalQuestions++;
            updateStats();
            if (gameMode === 'checkin') startQuestionTimer();
        }

        // æ¸²æŸ“æ‰‘å…‹ç‰Œ
        function renderCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';

            currentCards.forEach(card => {
                const el = document.createElement('div');
                el.className = `card ${card.suit.color}`;
                el.innerHTML = `
                    <div class="card-number">${card.display}</div>
                    <div class="card-suit">${card.suit.symbol}</div>
                `;
                el.addEventListener('click', () => onCardClick(card, el));
                container.appendChild(el);
            });
        }

        // ç‚¹å‡»å¡ç‰Œï¼ŒåŠ å…¥å¯¹åº”çœŸå®å€¼
        function onCardClick(card, el) {
            if (card.used) return; // å·²ä½¿ç”¨ä¸å¯å†æ¬¡ä½¿ç”¨
            const val = String(card.realValue);
            addToExpression(val);
            card.used = true;
            if (el) {
                el.classList.add('used');
                el.style.pointerEvents = 'none';
            }
            updateAvailableNumbers();
        }

         // æ£€æŸ¥24ç‚¹æ˜¯å¦æœ‰è§£ï¼ˆç®€åŒ–ç‰ˆç®—æ³•ï¼‰
         function check24PointSolution(numbers) {
             const expr = find24Solution(numbers);
             if (expr) {
                 currentSolutionExpr = expr;
                 return true;
             }
             currentSolutionExpr = null;
             return false;
         }

         // è¿”å›ä¸€ä¸ªèƒ½è®¡ç®—å‡º24çš„è¡¨è¾¾å¼ï¼ˆè‹¥æ— è§£è¿”å›nullï¼‰
         function find24Solution(numbers) {
             const permutations = getPermutations(numbers);
             const ops = ['+', '-', '*', '/'];
             
             function safeEval(expression) {
                 try {
                     const v = eval(expression);
                     if (Math.abs(v - 24) < 1e-6) return true;
                 } catch (_) {}
                 return false;
             }
             
             for (const a of permutations) {
                 for (const o1 of ops) {
                     for (const o2 of ops) {
                         for (const o3 of ops) {
                             const x1 = `(${a[0]}${o1}${a[1]})${o2}${a[2]}${o3}${a[3]}`;
                             if (safeEval(x1)) return x1;
                             const x2 = `${a[0]}${o1}(${a[1]}${o2}${a[2]})${o3}${a[3]}`;
                             if (safeEval(x2)) return x2;
                             const x3 = `${a[0]}${o1}${a[1]}${o2}(${a[2]}${o3}${a[3]})`;
                             if (safeEval(x3)) return x3;
                             const x4 = `(${a[0]}${o1}${a[1]})${o2}(${a[2]}${o3}${a[3]})`;
                             if (safeEval(x4)) return x4;
                             const x5 = `${a[0]}${o1}(${a[1]}${o2}(${a[2]}${o3}${a[3]}))`;
                             if (safeEval(x5)) return x5;
                         }
                     }
                 }
             }
             return null;
         }

        // ç”Ÿæˆæ’åˆ—ï¼ˆç¼ºå¤±è¡¥ä¸Šï¼‰
        function getPermutations(arr) {
            const res = [];
            function backtrack(path, used) {
                if (path.length === arr.length) {
                    res.push(path.slice());
                    return;
                }
                for (let i = 0; i < arr.length; i++) {
                    if (used[i]) continue;
                    used[i] = true;
                    path.push(arr[i]);
                    backtrack(path, used);
                    path.pop();
                    used[i] = false;
                }
            }
            backtrack([], Array(arr.length).fill(false));
            return res;
        }

         // æ·»åŠ åˆ°è¡¨è¾¾å¼
         function addToExpression(value) {
             if (value === '11') value = '10'; // J
             else if (value === '12') value = '10'; // Q
             else if (value === '13') value = '10'; // K
             else if (value === '14') value = '1'; // A
             
             currentExpression += value;
             updateExpressionDisplay();
         }

         // æ›´æ–°è¡¨è¾¾å¼æ˜¾ç¤º
         function updateExpressionDisplay() {
             const display = document.getElementById('expression-display');
             if (currentExpression) {
                 let displayExpr = currentExpression
                     .replace(/\*/g, 'Ã—')
                     .replace(/\//g, 'Ã·');
                 display.textContent = displayExpr + ' = ?';
             } else {
                 // ç§»é™¤å ä½æ–‡æ¡ˆï¼Œä¿æŒç©ºç™½æ¡†
                 display.textContent = '';
             }
         }

         // æ›´æ–°å¯ç”¨æ•°å­—ï¼ˆä½¿ç”¨çœŸå®å€¼ç»Ÿè®¡ï¼‰
         function updateAvailableNumbers() {
             const exprNums = currentExpression.match(/\d+/g) || [];
             availableNumbers = currentCards.filter(c => !c.used).map(c => c.realValue);
         }

         // æ˜¾ç¤ºæç¤ºï¼ˆå±å¹•ä¸­é—´å°æ¡†æ˜¾ç¤º3ç§’ï¼‰
         function showHint() {
             let text = '';
             if (currentSolutionExpr) {
                 const m = currentSolutionExpr.match(/^\((\d+)([+\-*\/])(\d+)\)/);
                 if (m) {
                     const a = m[1], op = m[2], b = m[3];
                     const opShow = op === '*' ? 'Ã—' : (op === '/' ? 'Ã·' : op);
                     text = `å…ˆç®— ${a} ${opShow} ${b}`;
                 } else {
                     const m2 = currentSolutionExpr.match(/(\d+)([+\-*\/])(\d+)/);
                     if (m2) {
                         const a = m2[1], op = m2[2], b = m2[3];
                         const opShow = op === '*' ? 'Ã—' : (op === '/' ? 'Ã·' : op);
                         text = `å…ˆç®— ${a} ${opShow} ${b}`;
                     }
                 }
             }
             if (!text) {
                 text = 'è¯•è¯•å…ˆæŠŠä¸¤ä¸ªæ•°åˆå¹¶æˆä¸€ä¸ªä¸­é—´ç»“æœï¼Œä¾‹å¦‚ 6 Ã— 4';
             }
             const overlay = document.getElementById('center-hint');
             const hintTextEl = document.getElementById('center-hint-text');
             hintTextEl.textContent = text;
             overlay.classList.remove('hidden');
             anime({
                 targets: '#center-hint-box',
                 scale: [0.9, 1],
                 opacity: [0, 1],
                 duration: 200,
                 easing: 'easeOutQuad'
             });
             setTimeout(() => {
                 anime({
                     targets: '#center-hint-box',
                     scale: [1, 0.95],
                     opacity: [1, 0],
                     duration: 200,
                     easing: 'easeInQuad',
                     complete: () => overlay.classList.add('hidden')
                 });
             }, 3000);
         }

        // æ¸…é™¤è¡¨è¾¾å¼
        function clearExpression() {
            currentExpression = '';
            // é‡ç½®å¡ç‰Œä½¿ç”¨çŠ¶æ€
            currentCards.forEach(c => { c.used = false; });
            // è¿˜åŸå¡ç‰Œæ ·å¼å’Œç‚¹å‡»
            const container = document.getElementById('cards-container');
            if (container) {
                Array.from(container.children).forEach(el => {
                    el.classList.remove('used');
                    el.style.pointerEvents = '';
                });
            }
            availableNumbers = currentCards.map(card => card.realValue);
            updateExpressionDisplay();
            updateAvailableNumbers();
        }

        // åˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦
        function deleteLastChar() {
            currentExpression = currentExpression.slice(0, -1);
            updateExpressionDisplay();
            // é‡æ–°è®¡ç®—å¯ç”¨æ•°å­—
            updateAvailableNumbers();
        }



        // æäº¤ç­”æ¡ˆ
        function submitAnswer() {
            if (!currentExpression) return;
            
            try {
                const result = eval(currentExpression);
                
                if (Math.abs(result - 24) < 0.0001) {
                    // ç­”æ¡ˆæ­£ç¡®
                    handleCorrectAnswer();
                } else {
                    // ç­”æ¡ˆé”™è¯¯
                    handleWrongAnswer(result);
                }
            } catch (e) {
                showMessage('è¡¨è¾¾å¼æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‹¬å·åŒ¹é…', 'error');
            }
        }

        // å¤„ç†æ­£ç¡®ç­”æ¡ˆ
        function handleCorrectAnswer() {
            // æ­£ç¡®ååœæ­¢å½“å‰é¢˜ç›®çš„è®¡æ—¶
            if (timerInterval) clearInterval(timerInterval);
            gameStats.correctCount++;
            gameStats.score += 10;
            
            // æ˜¾ç¤ºåº†ç¥åŠ¨ç”»
            showCelebration();
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰“å¡
            if (gameMode === 'checkin' && gameStats.correctCount >= 50) {
                completeCheckIn();
                return;
            }
            
            // ç”Ÿæˆæ–°é¢˜ç›®å¹¶é‡æ–°å¼€å§‹è®¡æ—¶
            setTimeout(() => {
                generateNewCards();
                if (gameMode === 'checkin') startQuestionTimer();
            }, 2000);
        }

        // å¤„ç†é”™è¯¯ç­”æ¡ˆ
        function handleWrongAnswer(result) {
            showMessage(`ç»“æœæ˜¯ ${result}ï¼Œä¸æ˜¯24å“¦ï¼å†è¯•è¯•çœ‹ã€‚`, 'warning');
            
            // æ·»åŠ éœ‡åŠ¨æ•ˆæœ
            anime({
                targets: '#expression-display',
                translateX: [-10, 10, -10, 10, 0],
                duration: 500,
                easing: 'easeInOutQuart'
            });
        }



        // æ˜¾ç¤ºåº†ç¥åŠ¨ç”»
        function showCelebration() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.innerHTML = `
                <div class="text-6xl mb-4">ğŸ‰</div>
                <div class="text-2xl font-bold text-green-600 mb-2">å¤ªæ£’äº†ï¼</div>
                <div class="text-gray-600">ç­”æ¡ˆæ­£ç¡®ï¼+10åˆ†</div>
            `;
            
            document.getElementById('celebration-container').appendChild(celebration);
            
            anime({
                targets: celebration,
                scale: [0, 1.2, 1],
                opacity: [0, 1],
                duration: 800,
                easing: 'easeOutElastic(1, .8)',
                complete: () => {
                    setTimeout(() => {
                        anime({
                            targets: celebration,
                            scale: [1, 0],
                            opacity: [1, 0],
                            duration: 300,
                            complete: () => {
                                document.getElementById('celebration-container').removeChild(celebration);
                            }
                        });
                    }, 1500);
                }
            });
            
            // äº”å½©çº¸å±‘æ•ˆæœ
            createConfetti();
        }

        // åˆ›å»ºäº”å½©çº¸å±‘æ•ˆæœ
        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = '50%';
                confetti.style.pointerEvents = 'none';
                confetti.style.zIndex = '1000';
                
                document.body.appendChild(confetti);
                
                anime({
                    targets: confetti,
                    translateY: '100vh',
                    translateX: (Math.random() - 0.5) * 200,
                    rotate: Math.random() * 360,
                    duration: Math.random() * 2000 + 1000,
                    easing: 'easeInQuad',
                    complete: () => {
                        document.body.removeChild(confetti);
                    }
                });
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('current-score').textContent = gameStats.score;
            document.getElementById('correct-count').textContent = gameStats.correctCount;
            document.getElementById('total-questions').textContent = gameStats.totalQuestions;
            
            const successRate = gameStats.totalQuestions > 0 ? 
                Math.round((gameStats.correctCount / gameStats.totalQuestions) * 100) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        // å®Œæˆæ‰“å¡
        function completeCheckIn() {
            clearInterval(timerInterval);
            
            // ä¿å­˜æ‰“å¡æ•°æ®
            const today = new Date().toISOString().split('T')[0];
            const userData = JSON.parse(localStorage.getItem('wangqikai_data') || '{}');
            if (!userData.checkInData) userData.checkInData = {};
            
            userData.checkInData[today] = {
                ...userData.checkInData[today],
                cards: {
                    completed: true,
                    time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                    score: gameStats.score
                }
            };
            
            localStorage.setItem('wangqikai_data', JSON.stringify(userData));
            
            // æ˜¾ç¤ºå®ŒæˆåŠ¨ç”»
            showCompletionAnimation();
        }

        // æ˜¾ç¤ºå®ŒæˆåŠ¨ç”»
        function showCompletionAnimation() {
            const completion = document.createElement('div');
            completion.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            completion.innerHTML = `
                <div class="bg-white rounded-2xl p-8 text-center max-w-md mx-4">
                    <div class="text-6xl mb-4">ğŸ†</div>
                    <h2 class="text-3xl font-bold text-green-600 mb-4">æ‰“å¡æˆåŠŸï¼</h2>
                    <p class="text-gray-600 mb-6">æ­å–œä½ å®Œæˆäº†24ç‚¹å¡ç‰Œæ‰“å¡æŒ‘æˆ˜ï¼</p>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${gameStats.correctCount}</div>
                            <div class="text-sm text-gray-500">ç­”å¯¹é¢˜æ•°</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${gameStats.score}</div>
                            <div class="text-sm text-gray-500">è·å¾—åˆ†æ•°</div>
                        </div>
                    </div>
                    <button onclick="goBack()" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        è¿”å›ä¸»é¡µ
                    </button>
                </div>
            `;
            
            document.body.appendChild(completion);
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            clearInterval(timerInterval);
            
            if (gameStats.correctCount >= 50) {
                completeCheckIn();
            } else {
                // æ˜¾ç¤ºå¤±è´¥åŠ¨ç”»
                showFailureAnimation();
            }
        }

        // æ˜¾ç¤ºå¤±è´¥åŠ¨ç”»
        function showFailureAnimation() {
            const failure = document.createElement('div');
            failure.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            failure.innerHTML = `
                <div class="bg-white rounded-2xl p-8 text-center max-w-md mx-4">
                    <div class="text-6xl mb-4">â°</div>
                    <h2 class="text-3xl font-bold text-red-600 mb-4">æ—¶é—´åˆ°ï¼</h2>
                    <p class="text-gray-600 mb-6">å¾ˆé—æ†¾ï¼Œæ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å®Œæˆ50é¢˜</p>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${gameStats.correctCount}</div>
                            <div class="text-sm text-gray-500">å®Œæˆé¢˜æ•°</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${gameStats.score}</div>
                            <div class="text-sm text-gray-500">è·å¾—åˆ†æ•°</div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="restartGame()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            å†è¯•ä¸€æ¬¡
                        </button>
                        <button onclick="goBack()" class="flex-1 px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                            è¿”å›ä¸»é¡µ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(failure);
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            location.reload();
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            const colors = {
                info: 'bg-blue-100 text-blue-800 border-blue-200',
                success: 'bg-green-100 text-green-800 border-green-200',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                error: 'bg-red-100 text-red-800 border-red-200'
            };
            
            messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border ${colors[type]} max-w-sm`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            anime({
                targets: messageDiv,
                translateX: [300, 0],
                opacity: [0, 1],
                duration: 300,
                complete: () => {
                    setTimeout(() => {
                        anime({
                            targets: messageDiv,
                            translateX: [0, 300],
                            opacity: [1, 0],
                            duration: 300,
                            complete: () => {
                                document.body.removeChild(messageDiv);
                            }
                        });
                    }, 3000);
                }
            });
        }

        // åŠ è½½æ¸¸æˆç»Ÿè®¡
        function loadGameStats() {
            const stats = JSON.parse(localStorage.getItem('cards_game_stats') || '{}');
            document.getElementById('practice-score').textContent = stats.practiceScore || 0;
            document.getElementById('total-practice').textContent = stats.totalPractice || 0;
            document.getElementById('best-time').textContent = stats.bestTime || '--:--';
        }

        // ä¿å­˜æ¸¸æˆç»Ÿè®¡
        function saveGameStats() {
            const stats = {
                practiceScore: gameStats.score,
                totalPractice: (JSON.parse(localStorage.getItem('cards_game_stats') || '{}').totalPractice || 0) + 1,
                bestTime: gameMode === 'checkin' ? formatTime(600 - gameStats.timeLeft) : null
            };
            localStorage.setItem('cards_game_stats', JSON.stringify(stats));
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // å¯¼èˆªå‡½æ•°
        function goBack() {
            window.history.back();
        }

        function goHome() {
            window.location.href = 'index.html';
        }
    </script>

<!-- å±å¹•é€‚é…å¼€å…³ï¼ˆå³ä¸Šè§’ï¼‰ -->
<div id="viewport-switcher" class="fixed top-3 right-3 z-50 select-none">
  <div class="relative">
    <button id="adapt-toggle" class="flex items-center space-x-2 px-3 py-2 bg-white/80 backdrop-blur shadow-sm border border-gray-200 rounded-full hover:bg-white">
      <span id="adapt-icon">ğŸ§­</span>
      <span id="adapt-label" class="text-sm">è‡ªé€‚åº”</span>
    </button>
    <div id="adapt-menu" class="absolute right-0 mt-2 w-44 bg-white border border-gray-200 shadow-xl rounded-xl p-2 hidden">
      <button data-adapt="auto" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ§­</span><span>è‡ªåŠ¨è¯†åˆ«</span></button>
      <button data-adapt="desktop" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ’»</span><span>ç”µè„‘ç«¯</span></button>
      <button data-adapt="tablet" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ“Ÿ</span><span>å¹³æ¿ç«¯</span></button>
      <button data-adapt="mobile" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ“±</span><span>æ‰‹æœºç«¯</span></button>
    </div>
  </div>
</div>

<style>
  html[data-adapt="desktop"] body { max-width: 1280px; margin: 0 auto; }
  html[data-adapt="tablet"] body { max-width: 768px; margin: 0 auto; padding-left: 8px; padding-right: 8px; }
  html[data-adapt="mobile"] body { max-width: 390px; margin: 0 auto; padding-left: 12px; padding-right: 12px; }
  body { transition: max-width 0.25s ease; }
</style>
<script>
(function(){
  const root = document.documentElement;
  const KEY = 'adapt-mode';
  function detectMode(){ const w = window.innerWidth; if(w < 640) return 'mobile'; if(w < 1024) return 'tablet'; return 'desktop'; }
  function updateLabel(mode){ const label=document.getElementById('adapt-label'); const icon=document.getElementById('adapt-icon'); if(!label||!icon) return; const map={auto:['è‡ªé€‚åº”','ğŸ§­'],desktop:['ç”µè„‘ç«¯','ğŸ’»'],tablet:['å¹³æ¿ç«¯','ğŸ“Ÿ'],mobile:['æ‰‹æœºç«¯','ğŸ“±']}; const p=map[mode]||map.auto; label.textContent=p[0]; icon.textContent=p[1]; }
  function apply(mode){ if(mode==='auto'){ updateLabel('auto'); return; } root.setAttribute('data-adapt',mode); updateLabel(mode); }
  function init(){ const saved=localStorage.getItem(KEY)||'auto'; apply(saved); if(saved==='auto'){ const setByScreen=()=>{ const m=detectMode(); root.setAttribute('data-adapt',m); }; setByScreen(); window.addEventListener('resize',setByScreen); } }
  document.addEventListener('DOMContentLoaded',()=>{ const toggle=document.getElementById('adapt-toggle'); const menu=document.getElementById('adapt-menu'); if(toggle){ toggle.addEventListener('click',()=>menu.classList.toggle('hidden')); document.addEventListener('click',(e)=>{ if(!menu.contains(e.target) && e.target!==toggle){ menu.classList.add('hidden'); } }); }
    ['auto','desktop','tablet','mobile'].forEach(m=>{ const el=document.querySelector('#adapt-menu [data-adapt="'+m+'"]'); if(!el) return; el.addEventListener('click',()=>{ localStorage.setItem(KEY,m); if(m==='auto'){ updateLabel('auto'); const setByScreen=()=>{ const mm=detectMode(); root.setAttribute('data-adapt',mm); }; setByScreen(); window.addEventListener('resize',setByScreen); } else { root.setAttribute('data-adapt',m); updateLabel(m); window.removeEventListener('resize',()=>{}); } menu.classList.add('hidden'); }); });
    init();
  });
})();
</script>

<script src="sessions.js"></script>
</body>
</html>