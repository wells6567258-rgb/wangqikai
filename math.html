<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦ç»ƒä¹  - æ±ªçªå‡¯çš„å­¦ä¹ å¤©åœ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js" defer></script>
    <style>
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .question-card {
            transition: all 0.3s ease;
        }
        
        .question-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .answer-input {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        
        .answer-input:focus {
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .answer-input.correct {
            border-color: #7ED321;
            background-color: #F0F9E8;
        }
        
        .answer-input.incorrect {
            border-color: #EF4444;
            background-color: #FEF2F2;
        }
        
        .vertical-calculation {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            line-height: 2;
        }
        
        .draft-canvas {
            border: 2px dashed #D1D5DB;
            border-radius: 8px;
            background: #F9FAFB;
            cursor: crosshair;
        }
        
        .tool-btn {
            transition: all 0.2s ease;
        }
        
        .tool-btn:hover {
            transform: scale(1.05);
        }
        
        .tool-btn.active {
            background-color: #4A90E2;
            color: white;
        }
        
        .progress-step {
            position: relative;
        }
        
        .progress-step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -20px;
            width: 40px;
            height: 2px;
            background: #E5E7EB;
            transform: translateY(-50%);
        }
        
        .progress-step.completed::after {
            background: #7ED321;
        }
        
        .progress-step:last-child::after {
            display: none;
        }
    </style>
</head>
<body class="tw-theme bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                        â† è¿”å›
                    </button>
                    <h1 class="text-2xl font-bold text-gray-800">æ•°å­¦ç»ƒä¹ </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="open-ocr" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center space-x-2">
                        <span>ğŸ“·</span><span>æ‹ç…§å½•é¢˜</span>
                    </button>
                    <div class="text-sm text-gray-600">
                        è¿›åº¦: <span class="font-bold text-blue-600" id="overall-progress">0/50</span>
                    </div>
                    <button onclick="goHome()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8" id="progress-indicator">
            <div class="flex items-center justify-between">
                <button class="progress-step clickable-step flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" 
                        onclick="switchToSection('oral')" id="oral-step">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">1</div>
                    <span class="ml-2 text-sm font-medium text-blue-600">å£ç®—é¢˜</span>
                </button>
                <button class="progress-step clickable-step flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" 
                        onclick="switchToSection('vertical')" id="vertical-step">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm">2</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">ç«–å¼è®¡ç®—</span>
                </button>
                <button class="progress-step clickable-step flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" 
                        onclick="switchToSection('word')" id="word-step">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm">3</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">åº”ç”¨é¢˜</span>
                </button>
                <div class="progress-step flex items-center" id="complete-step">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm">âœ“</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">å®Œæˆ</span>
                </div>
            </div>
            
            <!-- æ•´ä½“è¿›åº¦æ¡ -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600">æ•´ä½“è¿›åº¦</span>
                    <span class="text-sm font-medium text-blue-600" id="progress-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-blue-400 to-green-500 h-3 rounded-full transition-all duration-500" 
                         style="width: 0%" id="progress-bar"></div>
                </div>
            </div>
        </div>

        <!-- å£ç®—é¢˜ä¸è‰ç¨¿å¹¶æ’ -->
        <div id="oral-draft-wrapper" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div id="oral-section" class="">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <span class="mr-3">ğŸ§®</span>å£ç®—é¢˜ (20é¢˜)
                            <span id="group-indicator" class="ml-4 px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-sm"></span>
                        </h2>
                        <div class="text-sm text-gray-600">
                            å¾—åˆ†: <span class="font-bold text-blue-600" id="oral-score">0</span>/20
                        </div>
                    </div>
                    
                    <div id="oral-questions" class="grid grid-cols-1 gap-4">
                        <!-- å£ç®—é¢˜ç›®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                    <!-- ç»„æ§ä»¶ç”±è„šæœ¬åŠ¨æ€æ·»åŠ  -->
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <span class="mr-2">ğŸ“</span>è‰ç¨¿åŒºåŸŸ
                    </h3>
                    <div class="flex items-center space-x-2">
                        <button class="tool-btn px-3 py-2 bg-blue-100 text-blue-800 rounded-lg active" id="pen-tool">
                            âœï¸ ç”»ç¬”
                        </button>
                        <button class="tool-btn px-3 py-2 bg-red-100 text-red-800 rounded-lg" id="eraser-tool">
                            ğŸ§½ æ©¡çš®
                        </button>
                        <button class="tool-btn px-3 py-2 bg-gray-100 text-gray-800 rounded-lg" onclick="clearCanvas()">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                    </div>
                </div>
                
                <div class="draft-canvas" id="canvas-container">
                    <canvas id="draft-canvas" width="800" height="300" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- ç«–å¼è®¡ç®—åŒºåŸŸï¼ˆå¹¶æ’è‰ç¨¿åŒºï¼‰ -->
        <div id="vertical-section" class="mb-8 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- å·¦ä¾§ï¼šç«–å¼é¢˜ç›® -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <span class="mr-3">âœï¸</span>ç«–å¼è®¡ç®— (15é¢˜)
                        </h2>
                        <div class="text-sm text-gray-600">
                            å¾—åˆ†: <span class="font-bold text-blue-600" id="vertical-score">0</span>/15
                        </div>
                    </div>
                    <div id="vertical-questions" class="space-y-6">
                        <!-- ç«–å¼é¢˜ç›®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                    <!-- ç»„æ§ä»¶ç”±è„šæœ¬åŠ¨æ€æ·»åŠ  -->
                </div>
                
                <!-- å³ä¾§ï¼šè‰ç¨¿åŒº -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“</span>è‰ç¨¿åŒºåŸŸ
                            </h3>
                            <div class="flex space-x-2">
                                <button id="vertical-pen-tool" class="tool-btn px-3 py-2 bg-gray-100 text-gray-800 rounded-lg">âœï¸ ç¬”</button>
                                <button id="vertical-eraser-tool" class="tool-btn px-3 py-2 bg-gray-100 text-gray-800 rounded-lg">ğŸ§½ æ©¡çš®</button>
                                <button id="vertical-clear-tool" class="tool-btn px-3 py-2 bg-gray-100 text-gray-800 rounded-lg" onclick="clearVerticalCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
                            </div>
                        </div>
                        <div class="draft-canvas" id="vertical-canvas-container">
                            <canvas id="vertical-draft-canvas" width="800" height="300" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº”ç”¨é¢˜åŒºåŸŸï¼ˆå¹¶æ’è‰ç¨¿åŒºï¼‰ -->
        <div id="word-section" class="mb-8 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- å·¦ä¾§ï¼šåº”ç”¨é¢˜æ¨¡æ¿ -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <span class="mr-3">ğŸ“š</span>åº”ç”¨é¢˜ (15é¢˜)
                        </h2>
                        <div class="text-sm text-gray-600">
                            å¾—åˆ†: <span class="font-bold text-blue-600" id="word-score">0</span>/15
                        </div>
                    </div>
                    
                    <div id="word-questions" class="space-y-6">
                        <!-- åº”ç”¨é¢˜å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                    
                    <!-- ç»„æ§ä»¶ç”±è„šæœ¬åŠ¨æ€æ·»åŠ  -->
                </div>

                <!-- å³ä¾§ï¼šè‰ç¨¿åŒº -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                <span class="mr-2">ğŸ“</span>è‰ç¨¿åŒºåŸŸ
                            </h3>
                            <div class="flex space-x-2">
                                <button id="word-pen-tool" class="tool-btn px-3 py-2 bg-gray-100 text-gray-800 rounded-lg">âœï¸ ç¬”</button>
                                <button id="word-eraser-tool" class="tool-btn px-3 py-2 bg-gray-100 text-gray-800 rounded-lg">ğŸ§½ æ©¡çš®</button>
                                <button id="word-clear-tool" class="tool-btn px-3 py-2 bg-gray-100 text-gray-800 rounded-lg" onclick="clearWordCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
                            </div>
                        </div>
                        <div class="draft-canvas" id="word-canvas-container">
                            <canvas id="word-draft-canvas" width="800" height="300" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‰ç¨¿åŒºåŸŸå·²ç§»è‡³å£ç®—å¹¶æ’ -->

        <!-- é”™é¢˜æœ¬ -->
        <div id="wrong-answers" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">âŒ</span>é”™é¢˜å›é¡¾
            </h3>
            <div id="wrong-questions" class="space-y-4">
                <!-- é”™é¢˜å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>

        <!-- å®Œæˆé¡µé¢ -->
        <div id="completion-page" class="bg-white rounded-2xl shadow-lg p-8 text-center hidden">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-3xl font-bold text-green-600 mb-4">æ•°å­¦ç»ƒä¹ å®Œæˆï¼</h2>
            <p class="text-gray-600 mb-6">æ­å–œä½ å®Œæˆäº†æ‰€æœ‰æ•°å­¦é¢˜ç›®ï¼</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-blue-600" id="final-oral-score">0</div>
                    <div class="text-sm text-gray-500">å£ç®—é¢˜å¾—åˆ†</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-green-600" id="final-vertical-score">0</div>
                    <div class="text-sm text-gray-500">ç«–å¼è®¡ç®—å¾—åˆ†</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-orange-600" id="final-word-score">0</div>
                    <div class="text-sm text-gray-500">åº”ç”¨é¢˜å¾—åˆ†</div>
                </div>
            </div>
            
            <div class="text-2xl font-bold text-purple-600 mb-6">
                æ€»åˆ†: <span id="final-total-score">0</span>/50
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="viewWrongAnswers()" class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium">
                    æŸ¥çœ‹é”™é¢˜
                </button>
                <button onclick="goBack()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    </main>

    <script>
        // æ•°å­¦ç»ƒä¹ ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
        let currentSection = 'oral';
        let oralQuestions = [];
        let verticalQuestions = [];
        let wordQuestions = [];
        let wrongAnswers = [];
        let scores = {
            oral: 0,
            vertical: 0,
            word: 0
        };
        // è®°å½•ç”¨æˆ·ä½œç­”ï¼ˆæŒ‰é¢˜å‹ä¸é¢˜å·ï¼‰ï¼Œæ”¯æŒåˆ†ç»„æ¸²æŸ“ä¸‹çš„å…¨é‡å®¡æ‰¹
        let userAnswers = {
            oral: {},
            vertical: {},
            word: {}
        };
        // é‡åšçŠ¶æ€
        let redoState = {
            active: false,
            mode: null,
            items: []
        };
        // å®ŒæˆçŠ¶æ€è·Ÿè¸ª
        let completionStatus = {
            oral: false,
            vertical: false,
            word: false
        };
        
        // åˆ†ç»„ç›¸å…³å˜é‡ï¼ˆæŒ‰é¢˜å‹ç‹¬ç«‹è®¾ç½®ï¼‰
        let currentGroup = 0; // å…¼å®¹æ—§é€»è¾‘ï¼šä½œä¸ºå½“å‰æ˜¾ç¤ºçš„ç»„ç´¢å¼•
        let currentGroupMap = { oral: 0, vertical: 0, word: 0 }; // æ¯é¢˜å‹ç‹¬ç«‹è¿›åº¦
        const groupSizeMap = {
            oral: 2,
            vertical: 1,
            word: 1
        };
        let totalGroups = {
            oral: 0,
            vertical: 0,
            word: 0
        };
        // æ ‡è®°è‰ç¨¿åŒºæ˜¯å¦å·²ä¹¦å†™è¿‡ç¨‹
        let hasDraftContent = false;
        let canvas, ctx;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#1F2937';
        let lineWidth = 3;

        // ç«–å¼è®¡ç®—è‰ç¨¿åŒºå˜é‡
        let verticalCanvas, verticalCtx;
        let verticalIsDrawing = false;
        let verticalCurrentTool = 'pen';

        // åº”ç”¨é¢˜è‰ç¨¿åŒºå˜é‡
        let wordCanvas, wordCtx;
        let wordIsDrawing = false;
        let wordCurrentTool = 'pen';

        // æ¯é¢˜æ•°æ®åº“ï¼ˆæ‰©å±•ç‰ˆï¼‰
        const questionTemplates = {
            oral: [
                { type: 'addition', min: 10, max: 99, weight: 3 },
                { type: 'subtraction', min: 10, max: 99, weight: 3 },
                { type: 'multiplication', min: 2, max: 12, weight: 2 },
                { type: 'division', min: 2, max: 12, weight: 2 },
                { type: 'addition_3digit', min: 100, max: 999, weight: 1 },
                { type: 'subtraction_3digit', min: 100, max: 999, weight: 1 },
                { type: 'mixed_operations', min: 1, max: 50, weight: 1 },
                { type: 'decimal_addition', min: 1, max: 99, weight: 1 },
                { type: 'decimal_subtraction', min: 1, max: 99, weight: 1 },
                { type: 'fraction_simple', min: 1, max: 10, weight: 1 }
            ],
            vertical: [
                { type: 'addition_2digit', weight: 3, min: 10, max: 99 },
                { type: 'subtraction_2digit', weight: 3, min: 10, max: 99 },
                { type: 'multiplication_2digit_1digit', weight: 2, min: 10, max: 99 },
                { type: 'addition_3digit', weight: 2, min: 100, max: 999 },
                { type: 'subtraction_3digit', weight: 2, min: 100, max: 999 },
                { type: 'multiplication_2digit', weight: 1, min: 10, max: 99 },
                { type: 'division_2digit', weight: 2, min: 2, max: 12 },
                { type: 'decimal_addition', weight: 1, min: 1, max: 50 },
                { type: 'decimal_subtraction', weight: 1, min: 1, max: 50 }
            ],
            word: [
                { type: 'basic_arithmetic', weight: 2 },
                { type: 'area_perimeter', weight: 2 },
                { type: 'multi_step', weight: 2 },
                { type: 'speed_distance_time', weight: 1 },
                { type: 'percentage', weight: 1 },
                { type: 'ratio', weight: 1 },
                { type: 'fraction', weight: 1 },
                { type: 'logic', weight: 1 }
            ]
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeDailySeed();
            initializeCanvas();
            generateAllQuestions();
            setupEventListeners();
            showSection('oral');
        });

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initializeCanvas() {
            // å£ç®—é¢˜è‰ç¨¿åŒº
            canvas = document.getElementById('draft-canvas');
            ctx = canvas.getContext('2d');
            const container = document.getElementById('canvas-container');
            canvas.width = container.offsetWidth;
            canvas.height = 300;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = lineWidth;

            // ç«–å¼è®¡ç®—è‰ç¨¿åŒº
            verticalCanvas = document.getElementById('vertical-draft-canvas');
            if (verticalCanvas) {
                verticalCtx = verticalCanvas.getContext('2d');
                const vContainer = verticalCanvas.parentElement;
                verticalCanvas.width = vContainer.offsetWidth;
                verticalCanvas.height = 300;
                verticalCtx.lineCap = 'round';
                verticalCtx.lineJoin = 'round';
                verticalCtx.strokeStyle = currentColor;
                verticalCtx.lineWidth = lineWidth;
            }

            // åº”ç”¨é¢˜è‰ç¨¿åŒº
            wordCanvas = document.getElementById('word-draft-canvas');
            if (wordCanvas) {
                wordCtx = wordCanvas.getContext('2d');
                const wContainer = wordCanvas.parentElement;
                wordCanvas.width = wContainer.offsetWidth;
                wordCanvas.height = 300;
                wordCtx.lineCap = 'round';
                wordCtx.lineJoin = 'round';
                wordCtx.strokeStyle = currentColor;
                wordCtx.lineWidth = lineWidth;
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å£ç®—é¢˜è‰ç¨¿åŒºäº‹ä»¶
            document.getElementById('pen-tool').addEventListener('click', () => setTool('pen'));
            document.getElementById('eraser-tool').addEventListener('click', () => setTool('eraser'));
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);

            // ç«–å¼è®¡ç®—è‰ç¨¿åŒºäº‹ä»¶
            const vPen = document.getElementById('vertical-pen-tool');
            const vEraser = document.getElementById('vertical-eraser-tool');
            const vClear = document.getElementById('vertical-clear-tool');
            if (vPen && vEraser) {
                vPen.addEventListener('click', () => setVerticalTool('pen'));
                vEraser.addEventListener('click', () => setVerticalTool('eraser'));
            }
            if (vClear) {
                vClear.addEventListener('click', clearVerticalCanvas);
            }
            if (verticalCanvas) {
                verticalCanvas.addEventListener('mousedown', startVerticalDrawing);
                verticalCanvas.addEventListener('mousemove', drawVertical);
                verticalCanvas.addEventListener('mouseup', stopVerticalDrawing);
                verticalCanvas.addEventListener('mouseout', stopVerticalDrawing);
                verticalCanvas.addEventListener('touchstart', handleVerticalTouch);
                verticalCanvas.addEventListener('touchmove', handleVerticalTouch);
                verticalCanvas.addEventListener('touchend', stopVerticalDrawing);
            }

            // åº”ç”¨é¢˜è‰ç¨¿åŒºäº‹ä»¶
            const wPen = document.getElementById('word-pen-tool');
            const wEraser = document.getElementById('word-eraser-tool');
            const wClear = document.getElementById('word-clear-tool');
            if (wPen && wEraser) {
                wPen.addEventListener('click', () => setWordTool('pen'));
                wEraser.addEventListener('click', () => setWordTool('eraser'));
            }
            if (wClear) {
                wClear.addEventListener('click', clearWordCanvas);
            }
            if (wordCanvas) {
                wordCanvas.addEventListener('mousedown', startWordDrawing);
                wordCanvas.addEventListener('mousemove', drawWord);
                wordCanvas.addEventListener('mouseup', stopWordDrawing);
                wordCanvas.addEventListener('mouseout', stopWordDrawing);
                wordCanvas.addEventListener('touchstart', handleWordTouch);
                wordCanvas.addEventListener('touchmove', handleWordTouch);
                wordCanvas.addEventListener('touchend', stopWordDrawing);
            }
        }

        // ç”Ÿæˆæ‰€æœ‰é¢˜ç›®
        function generateAllQuestions() {
            generateOralQuestions();
            generateVerticalQuestions();
            generateWordQuestions();
        }

        // æ¯æ—¥ç§å­éšæœºæ•°ç”Ÿæˆå™¨
        let dailySeed = 0;
        
        function initializeDailySeed() {
            const today = new Date();
            const dateString = today.getFullYear() + '' + 
                              (today.getMonth() + 1).toString().padStart(2, '0') + '' +
                              today.getDate().toString().padStart(2, '0');
            dailySeed = parseInt(dateString);
        }
        
        // åŸºäºç§å­çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆçº¿æ€§åŒä½™ç”Ÿæˆå™¨ï¼‰
        function seededRandom() {
            dailySeed = (dailySeed * 9301 + 49297) % 233280;
            return dailySeed / 233280;
        }
        
        // æ ¹æ®æƒé‡é€‰æ‹©é¢˜ç›®æ¨¡æ¿ï¼ˆä½¿ç”¨æ¯æ—¥ç§å­ï¼‰
        function selectTemplateByWeight(templates) {
            const totalWeight = templates.reduce((sum, t) => sum + t.weight, 0);
            let random = seededRandom() * totalWeight;
            
            for (const template of templates) {
                random -= template.weight;
                if (random <= 0) {
                    return template;
                }
            }
            return templates[0]; // å¤‡ç”¨
        }

        // ç”Ÿæˆå£ç®—é¢˜ï¼ˆæ‰©å±•ç‰ˆï¼‰
        function generateOralQuestions() {
            oralQuestions = [];
            for (let i = 0; i < 20; i++) {
                const template = selectTemplateByWeight(questionTemplates.oral);
                let question = {};
                
                switch (template.type) {
                    case 'addition':
                        const a = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const b = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        question = {
                            question: `${a} + ${b} = `,
                            answer: a + b,
                            type: 'addition'
                        };
                        break;
                    case 'subtraction':
                        const c = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const d = Math.floor(seededRandom() * c) + 1;
                        question = {
                            question: `${c} - ${d} = `,
                            answer: c - d,
                            type: 'subtraction'
                        };
                        break;
                    case 'multiplication':
                        const e = Math.floor(seededRandom() * template.max) + template.min;
                        const f = Math.floor(seededRandom() * template.max) + template.min;
                        question = {
                            question: `${e} Ã— ${f} = `,
                            answer: e * f,
                            type: 'multiplication'
                        };
                        break;
                    case 'division':
                        const g = Math.floor(seededRandom() * template.max) + template.min;
                        const h = Math.floor(seededRandom() * template.max) + template.min;
                        const product = g * h;
                        question = {
                            question: `${product} Ã· ${g} = `,
                            answer: h,
                            type: 'division'
                        };
                        break;
                    case 'addition_3digit':
                        const a3 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const b3 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        question = {
                            question: `${a3} + ${b3} = `,
                            answer: a3 + b3,
                            type: 'addition_3digit'
                        };
                        break;
                    case 'subtraction_3digit':
                        const c3 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const d3 = Math.floor(seededRandom() * c3) + 1;
                        question = {
                            question: `${c3} - ${d3} = `,
                            answer: c3 - d3,
                            type: 'subtraction_3digit'
                        };
                        break;
                    case 'mixed_operations':
                        const x = Math.floor(seededRandom() * template.max) + template.min;
                        const y = Math.floor(seededRandom() * template.max) + template.min;
                        const z = Math.floor(seededRandom() * template.max) + template.min;
                        question = {
                            question: `${x} + ${y} - ${z} = `,
                            answer: x + y - z,
                            type: 'mixed_operations'
                        };
                        break;
                    case 'decimal_addition':
                        const da = (Math.floor(seededRandom() * template.max) + template.min) + parseFloat(seededRandom().toFixed(1));
                        const db = (Math.floor(seededRandom() * template.max) + template.min) + parseFloat(seededRandom().toFixed(1));
                        question = {
                            question: `${da.toFixed(1)} + ${db.toFixed(1)} = `,
                            answer: parseFloat((da + db).toFixed(1)),
                            type: 'decimal_addition'
                        };
                        break;
                    case 'decimal_subtraction':
                        const dc = (Math.floor(seededRandom() * template.max) + template.min) + parseFloat(seededRandom().toFixed(1));
                        const dd = Math.floor(seededRandom() * dc * 10) / 10;
                        question = {
                            question: `${dc.toFixed(1)} - ${dd.toFixed(1)} = `,
                            answer: parseFloat((dc - dd).toFixed(1)),
                            type: 'decimal_subtraction'
                        };
                        break;
                    case 'fraction_simple':
                        const num = Math.floor(seededRandom() * template.max) + template.min;
                        const den = Math.floor(seededRandom() * template.max) + template.min;
                        const whole = Math.floor(seededRandom() * 5) + 1;
                        question = {
                            question: `${whole} + ${num}/${den} = `,
                            answer: `${whole * den + num}/${den}`,
                            type: 'fraction_simple'
                        };
                        break;
                }
                
                oralQuestions.push(question);
            }
            
            totalGroups.oral = Math.ceil(oralQuestions.length / groupSizeMap.oral);
            renderOralQuestions();
        }

        // æ¸²æŸ“å£ç®—é¢˜ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰
        function renderOralQuestions() {
            const container = document.getElementById('oral-questions');
            container.innerHTML = '';
            
            // è®¡ç®—å½“å‰ç»„çš„é¢˜ç›®èŒƒå›´
            const group = currentGroupMap.oral;
            const startIndex = group * groupSizeMap.oral;
            const endIndex = Math.min(startIndex + groupSizeMap.oral, oralQuestions.length);
            const currentQuestions = oralQuestions.slice(startIndex, endIndex);
            
            // æ›´æ–°ç»„æŒ‡ç¤ºå™¨ï¼ˆæ ‡é¢˜åŒºåŸŸï¼‰
            const groupIndicator = document.getElementById('group-indicator');
            if (groupIndicator) {
                groupIndicator.textContent = `ç¬¬ ${group + 1} ç»„ (${startIndex + 1}-${endIndex} é¢˜)`;
            }
            
            currentQuestions.forEach((q, index) => {
                const actualIndex = startIndex + index;
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card bg-gray-50 rounded-lg p-4 h-24 flex items-center';
                questionDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="text-lg font-medium">
                            <span class="question-index text-indigo-600 font-bold mr-1">${actualIndex + 1}.</span> ${q.question}
                        </div>
                        <input type="number" 
                               class="answer-input w-24" 
                               id="oral-answer-${actualIndex}"
                               placeholder="?"
                               data-index="${actualIndex}"
                               value="${(userAnswers.oral?.[actualIndex] ?? '').toString()}"
                               oninput="recordAnswer('oral', ${actualIndex}, this.value)">
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            // æ·»åŠ æ£€æŸ¥å’Œä¸‹ä¸€ç»„æŒ‰é’®
            addGroupControls(container, 'oral');
        }

        // ç”Ÿæˆç«–å¼è®¡ç®—é¢˜
        function generateVerticalQuestions() {
            verticalQuestions = [];
            for (let i = 0; i < 15; i++) {
                const template = selectTemplateByWeight(questionTemplates.vertical);
                let question = {};
                
                switch (template.type) {
                    case 'addition_2digit':
                        const a = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const b = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        question = {
                            question: `${a} + ${b}`,
                            answer: a + b,
                            type: 'addition',
                            steps: generateAdditionSteps(a, b)
                        };
                        break;
                    case 'subtraction_2digit':
                        const c = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const d = Math.floor(seededRandom() * c) + 1;
                        question = {
                            question: `${c} - ${d}`,
                            answer: c - d,
                            type: 'subtraction',
                            steps: generateSubtractionSteps(c, d)
                        };
                        break;
                    case 'multiplication_2digit_1digit':
                        const e = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const f = Math.floor(seededRandom() * 8) + 2;
                        question = {
                            question: `${e} Ã— ${f}`,
                            answer: e * f,
                            type: 'multiplication',
                            steps: generateMultiplicationSteps(e, f)
                        };
                        break;
                    case 'addition_3digit':
                        const a3 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const b3 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        question = {
                            question: `${a3} + ${b3}`,
                            answer: a3 + b3,
                            type: 'addition',
                            steps: generateAdditionSteps(a3, b3)
                        };
                        break;
                    case 'subtraction_3digit':
                        const c3 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const d3 = Math.floor(seededRandom() * c3) + 1;
                        question = {
                            question: `${c3} - ${d3}`,
                            answer: c3 - d3,
                            type: 'subtraction',
                            steps: generateSubtractionSteps(c3, d3)
                        };
                        break;
                    case 'multiplication_2digit':
                        const e2 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const f2 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        question = {
                            question: `${e2} Ã— ${f2}`,
                            answer: e2 * f2,
                            type: 'multiplication',
                            steps: generateMultiplicationSteps(e2, f2)
                        };
                        break;
                    case 'division_2digit':
                        const g2 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const h2 = Math.floor(seededRandom() * (template.max - template.min)) + template.min;
                        const product2 = g2 * h2;
                        question = {
                            question: `${product2} Ã· ${g2}`,
                            answer: h2,
                            type: 'division',
                            steps: generateDivisionSteps(product2, g2)
                        };
                        break;
                    case 'decimal_addition':
                        const da = parseFloat((Math.floor(seededRandom() * template.max) + template.min + seededRandom()).toFixed(2));
                        const db = parseFloat((Math.floor(seededRandom() * template.max) + template.min + seededRandom()).toFixed(2));
                        question = {
                            question: `${da} + ${db}`,
                            answer: parseFloat((da + db).toFixed(2)),
                            type: 'addition',
                            steps: generateDecimalAdditionSteps(da, db)
                        };
                        break;
                    case 'decimal_subtraction':
                        const dc = parseFloat((Math.floor(seededRandom() * template.max) + template.min + seededRandom()).toFixed(2));
                        const dd = parseFloat((seededRandom() * dc).toFixed(2));
                        question = {
                            question: `${dc} - ${dd}`,
                            answer: parseFloat((dc - dd).toFixed(2)),
                            type: 'subtraction',
                            steps: generateDecimalSubtractionSteps(dc, dd)
                        };
                        break;
                }
                
                verticalQuestions.push(question);
            }
            
            totalGroups.vertical = verticalQuestions.length; // ä¸€é¢˜ä¸€ç»„
            renderVerticalQuestions();
        }

        // ç”ŸæˆåŠ æ³•æ­¥éª¤
        function generateAdditionSteps(a, b) {
            const aStr = a.toString();
            const bStr = b.toString().padStart(aStr.length, '0');
            const result = a + b;
            
            return {
                numbers: [aStr, bStr],
                result: result.toString(),
                carries: []
            };
        }

        // ç”Ÿæˆå‡æ³•æ­¥éª¤
        function generateSubtractionSteps(a, b) {
            const aStr = a.toString();
            const bStr = b.toString().padStart(aStr.length, '0');
            const result = a - b;
            
            return {
                numbers: [aStr, bStr],
                result: result.toString(),
                borrows: []
            };
        }

        // ç”Ÿæˆä¹˜æ³•æ­¥éª¤
        function generateMultiplicationSteps(a, b) {
            const aStr = a.toString();
            const bStr = b.toString();
            const result = a * b;
            const partialProducts = [];
            
            for (let i = bStr.length - 1; i >= 0; i--) {
                const digit = parseInt(bStr[i]);
                const partial = a * digit;
                partialProducts.push(partial.toString());
            }
            
            return {
                numbers: [aStr, bStr],
                result: result.toString(),
                partialProducts: partialProducts
            };
        }

        // ç”Ÿæˆé™¤æ³•æ­¥éª¤
        function generateDivisionSteps(dividend, divisor) {
            const dividendStr = dividend.toString();
            const divisorStr = divisor.toString();
            const quotient = Math.floor(dividend / divisor);
            const remainder = dividend % divisor;
            
            return {
                dividend: dividendStr,
                divisor: divisorStr,
                quotient: quotient.toString(),
                remainder: remainder.toString()
            };
        }

        // ç”Ÿæˆå°æ•°åŠ æ³•æ­¥éª¤
        function generateDecimalAdditionSteps(a, b) {
            const aStr = a.toString();
            const bStr = b.toString();
            const result = (a + b).toFixed(2);
            
            return {
                numbers: [aStr, bStr],
                result: result,
                type: 'decimal_addition'
            };
        }

        // ç”Ÿæˆå°æ•°å‡æ³•æ­¥éª¤
        function generateDecimalSubtractionSteps(a, b) {
            const aStr = a.toString();
            const bStr = b.toString();
            const result = (a - b).toFixed(2);
            
            return {
                numbers: [aStr, bStr],
                result: result,
                type: 'decimal_subtraction'
            };
        }

        // æ¸²æŸ“ç«–å¼é¢˜ç›®ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰
        function renderVerticalQuestions() {
            const container = document.getElementById('vertical-questions');
            container.innerHTML = '';
            
            // è®¡ç®—å½“å‰ç»„çš„é¢˜ç›®èŒƒå›´
            const group = currentGroupMap.vertical;
            const startIndex = group * groupSizeMap.vertical;
            const endIndex = Math.min(startIndex + groupSizeMap.vertical, verticalQuestions.length);
            const currentQuestions = verticalQuestions.slice(startIndex, endIndex);
            
            // æ·»åŠ ç»„æ ‡é¢˜
            const groupTitle = document.createElement('div');
            groupTitle.className = 'text-xl font-bold text-center mb-6 text-green-600';
            groupTitle.textContent = `ç¬¬ ${group + 1} ç»„ (${startIndex + 1}-${endIndex} é¢˜)`;
            container.appendChild(groupTitle);
            
            currentQuestions.forEach((q, index) => {
                const actualIndex = startIndex + index;
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card bg-gray-50 rounded-lg p-6';
                
                let verticalHTML = '';
                if (q.type === 'addition') {
                    verticalHTML = renderAdditionVertical(q, actualIndex);
                } else if (q.type === 'subtraction') {
                    verticalHTML = renderSubtractionVertical(q, actualIndex);
                } else if (q.type === 'multiplication') {
                    verticalHTML = renderMultiplicationVertical(q, actualIndex);
                }
                
                questionDiv.innerHTML = `
                    <div class="mb-4">
                        <span class="font-medium">ç¬¬ ${actualIndex + 1} é¢˜: ${q.question}</span>
                    </div>
                    ${verticalHTML}
                `;
                
                container.appendChild(questionDiv);
            });
            
            // æ·»åŠ æ£€æŸ¥å’Œä¸‹ä¸€ç»„æŒ‰é’®
            addGroupControls(container, 'vertical');
        }

        // æ¸²æŸ“åŠ æ³•ç«–å¼
        function renderAdditionVertical(question, index) {
            const steps = question.steps;
            return `
                <div class="vertical-calculation mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="border-b border-gray-400 pb-1 mb-1">${steps.numbers[0]}</div>
                            <div>+ ${steps.numbers[1]}</div>
                            <div class="border-t border-gray-400 pt-1 mt-1">
                                <input type="number" 
                                       class="answer-input w-32 text-right" 
                                       id="vertical-answer-${index}"
                                       placeholder="?"
                                       data-index="${index}"
                                       value="${(userAnswers.vertical?.[index] ?? '').toString()}"
                                       oninput="recordAnswer('vertical', ${index}, this.value)">
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            æç¤ºï¼šç›¸åŒæ•°ä½è¦å¯¹é½ï¼Œä»ä¸ªä½åŠ èµ·ï¼Œæ»¡åè¿›ä¸€
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“å‡æ³•ç«–å¼
        function renderSubtractionVertical(question, index) {
            const steps = question.steps;
            return `
                <div class="vertical-calculation mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="border-b border-gray-400 pb-1 mb-1">${steps.numbers[0]}</div>
                            <div>- ${steps.numbers[1]}</div>
                            <div class="border-t border-gray-400 pt-1 mt-1">
                                <input type="number" 
                                       class="answer-input w-32 text-right" 
                                       id="vertical-answer-${index}"
                                       placeholder="?"
                                       data-index="${index}"
                                       value="${(userAnswers.vertical?.[index] ?? '').toString()}"
                                       oninput="recordAnswer('vertical', ${index}, this.value)">
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            æç¤ºï¼šç›¸åŒæ•°ä½è¦å¯¹é½ï¼Œä»ä¸ªä½å‡èµ·ï¼Œä¸å¤Ÿå‡æ—¶å‘å‰ä¸€ä½å€Ÿ1å½“10
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“ä¹˜æ³•ç«–å¼
        function renderMultiplicationVertical(question, index) {
            const steps = question.steps;
            return `
                <div class="vertical-calculation mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="border-b border-gray-400 pb-1 mb-1">${steps.numbers[0]}</div>
                            <div>Ã— ${steps.numbers[1]}</div>
                            <div class="border-t border-gray-400 pt-1 mt-1">
                                <input type="number" 
                                       class="answer-input w-32 text-right" 
                                       id="vertical-answer-${index}"
                                       placeholder="?"
                                       data-index="${index}"
                                       value="${(userAnswers.vertical?.[index] ?? '').toString()}"
                                       oninput="recordAnswer('vertical', ${index}, this.value)">
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            æç¤ºï¼šä»ä¸ªä½ç®—èµ·ï¼Œç”¨ä¹˜æ•°ä¾æ¬¡å»ä¹˜è¢«ä¹˜æ•°çš„æ¯ä¸€ä½
                        </div>
                    </div>
                </div>
            `;
        }

        // ç”Ÿæˆåº”ç”¨é¢˜
        function generateWordQuestions() {
            wordQuestions = [];
            
            for (let i = 0; i < 15; i++) {
                const template = selectTemplateByWeight(questionTemplates.word);
                let question = {};
                
                switch (template.type) {
                    case 'basic_arithmetic':
                        const items = Math.floor(seededRandom() * 50) + 20;
                        const groups = Math.floor(seededRandom() * 8) + 2;
                        const result = Math.floor(items / groups);
                        question = {
                            question: `å°æ˜æœ‰${items}ä¸ªè‹¹æœï¼Œè¦å¹³å‡åˆ†ç»™${groups}ä¸ªå°æœ‹å‹ï¼Œæ¯ä¸ªå°æœ‹å‹èƒ½åˆ†åˆ°å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                            answer: result,
                            solution: `${items} Ã· ${groups} = ${result} (ä¸ª)`,
                            type: 'basic_arithmetic'
                        };
                        break;
                    case 'area_perimeter':
                        const length = Math.floor(seededRandom() * 100) + 50;
                        const width = Math.floor(seededRandom() * 80) + 30;
                        const perimeter = (length + width) * 2;
                        question = {
                            question: `ä¸€ä¸ªé•¿æ–¹å½¢æ“åœºé•¿${length}ç±³ï¼Œå®½${width}ç±³ï¼Œå°æ˜ç»•ç€æ“åœºè·‘ä¸€åœˆï¼Œä»–è·‘äº†å¤šå°‘ç±³ï¼Ÿ`,
                            answer: perimeter,
                            solution: `(${length} + ${width}) Ã— 2 = ${perimeter} (ç±³)`,
                            type: 'area_perimeter'
                        };
                        break;
                    case 'multi_step':
                        const boxes = Math.floor(seededRandom() * 5) + 2;
                        const itemsPerBox = Math.floor(seededRandom() * 10) + 5;
                        const totalCost = Math.floor(seededRandom() * 200) + 50;
                        const costPerItem = Math.floor(totalCost / (boxes * itemsPerBox));
                        question = {
                            question: `å¦ˆå¦ˆä¹°äº†${boxes}ç®±ç‰›å¥¶ï¼Œæ¯ç®±æœ‰${itemsPerBox}ç›’ï¼Œä¸€å…±èŠ±äº†${totalCost}å…ƒï¼Œå¹³å‡æ¯ç›’ç‰›å¥¶å¤šå°‘å…ƒï¼Ÿ`,
                            answer: costPerItem,
                            solution: `${totalCost} Ã· (${boxes} Ã— ${itemsPerBox}) = ${costPerItem} (å…ƒ)`,
                            type: 'multi_step'
                        };
                        break;
                    case 'speed_distance_time':
                        const speed = Math.floor(seededRandom() * 60) + 20;
                        const time = Math.floor(seededRandom() * 3) + 1;
                        const distance = speed * time;
                        question = {
                            question: `ä¸€è¾†æ±½è½¦æ¯å°æ—¶è¡Œé©¶${speed}åƒç±³ï¼Œè¡Œé©¶äº†${time}å°æ—¶ï¼Œä¸€å…±è¡Œé©¶äº†å¤šå°‘åƒç±³ï¼Ÿ`,
                            answer: distance,
                            solution: `${speed} Ã— ${time} = ${distance} (åƒç±³)`,
                            type: 'speed_distance'
                        };
                        break;
                    case 'percentage':
                        const total = Math.floor(seededRandom() * 200) + 100;
                        const percentage = Math.floor(seededRandom() * 50) + 20;
                        const result_pct = Math.floor(total * percentage / 100);
                        question = {
                            question: `ä¸€ä»¶è¡£æœåŸä»·${total}å…ƒï¼Œç°åœ¨æ‰“${percentage}%æŠ˜ï¼Œç°åœ¨çš„ä»·æ ¼æ˜¯å¤šå°‘å…ƒï¼Ÿ`,
                            answer: result_pct,
                            solution: `${total} Ã— ${percentage}% = ${result_pct} (å…ƒ)`,
                            type: 'percentage'
                        };
                        break;
                    case 'ratio':
                        const boys = Math.floor(seededRandom() * 20) + 10;
                        const girls = Math.floor(seededRandom() * 20) + 10;
                        const totalStudents = boys + girls;
                        question = {
                            question: `ç­çº§é‡Œæœ‰ç”·ç”Ÿ${boys}äººï¼Œå¥³ç”Ÿ${girls}äººï¼Œç”·ç”Ÿå’Œå¥³ç”Ÿçš„æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Ÿ`,
                            answer: `${boys}:${girls}`,
                            solution: `ç”·ç”Ÿ:å¥³ç”Ÿ = ${boys}:${girls}`,
                            type: 'ratio'
                        };
                        break;
                    case 'fraction':
                        const rope = Math.floor(seededRandom() * 30) + 10;
                        const numerator = Math.floor(seededRandom() * 4) + 1;
                        const denominator = Math.floor(seededRandom() * 5) + 3;
                        const used = Math.floor(rope * numerator / denominator);
                        question = {
                            question: `ä¸€æ ¹ç»³å­é•¿${rope}ç±³ï¼Œç”¨å»äº†å®ƒçš„${numerator}/${denominator}ï¼Œç”¨å»äº†å¤šå°‘ç±³ï¼Ÿ`,
                            answer: used,
                            solution: `${rope} Ã· ${denominator} Ã— ${numerator} = ${used} (ç±³)`,
                            type: 'fraction'
                        };
                        break;
                    case 'logic':
                        const age1 = Math.floor(seededRandom() * 20) + 20;
                        const ageDiff = Math.floor(seededRandom() * 10) + 5;
                        const age2 = age1 + ageDiff;
                        const totalAge = age1 + age2;
                        question = {
                            question: `çˆ¸çˆ¸æ¯”å„¿å­å¤§${ageDiff}å²ï¼Œä¸¤äººå¹´é¾„ä¹‹å’Œæ˜¯${totalAge}å²ï¼Œå„¿å­ä»Šå¹´å¤šå°‘å²ï¼Ÿ`,
                            answer: age1,
                            solution: `(${totalAge} - ${ageDiff}) Ã· 2 = ${age1} (å²)`,
                            type: 'logic'
                        };
                        break;
                    default:
                        // é»˜è®¤åŸºç¡€ç®—æœ¯é¢˜
                        const defaultItems = Math.floor(seededRandom() * 50) + 20;
                        const defaultGroups = Math.floor(seededRandom() * 8) + 2;
                        const defaultResult = Math.floor(defaultItems / defaultGroups);
                        question = {
                            question: `å°æ˜æœ‰${defaultItems}ä¸ªè‹¹æœï¼Œè¦å¹³å‡åˆ†ç»™${defaultGroups}ä¸ªå°æœ‹å‹ï¼Œæ¯ä¸ªå°æœ‹å‹èƒ½åˆ†åˆ°å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                            answer: defaultResult,
                            solution: `${defaultItems} Ã· ${defaultGroups} = ${defaultResult} (ä¸ª)`,
                            type: 'basic_arithmetic'
                        };
                }
                
                question.id = i;
                wordQuestions.push(question);
            }
            
            totalGroups.word = wordQuestions.length; // ä¸€é¢˜ä¸€ç»„
            renderWordQuestions();
        }

        // æ¸²æŸ“åº”ç”¨é¢˜ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰
        function renderWordQuestions() {
            const container = document.getElementById('word-questions');
            container.innerHTML = '';
            
            // è®¡ç®—å½“å‰ç»„çš„é¢˜ç›®èŒƒå›´
            const group = currentGroupMap.word;
            const startIndex = group * groupSizeMap.word;
            const endIndex = Math.min(startIndex + groupSizeMap.word, wordQuestions.length);
            const currentQuestions = wordQuestions.slice(startIndex, endIndex);
            
            // æ·»åŠ ç»„æ ‡é¢˜
            const groupTitle = document.createElement('div');
            groupTitle.className = 'text-xl font-bold text-center mb-6 text-purple-600';
            groupTitle.textContent = `ç¬¬ ${group + 1} ç»„ (${startIndex + 1}-${endIndex} é¢˜)`;
            container.appendChild(groupTitle);
            
            currentQuestions.forEach((q, index) => {
                const actualIndex = startIndex + index;
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card bg-gray-50 rounded-lg p-6';
                questionDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="font-medium mb-2">ç¬¬ ${actualIndex + 1} é¢˜:</div>
                        <div class="text-gray-700 mb-4">${q.question}</div>
                        <div class="flex items-center space-x-4">
                            <span class="font-medium">ç­”æ¡ˆ:</span>
                        <input type="text" 
                               class="answer-input w-32" 
                               id="word-answer-${actualIndex}"
                               placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                               data-index="${actualIndex}"
                               value="${(userAnswers.word?.[actualIndex] ?? '').toString()}"
                               oninput="recordAnswer('word', ${actualIndex}, this.value)">
                            <span class="text-sm text-gray-500">å•ä½å·²åœ¨é¢˜ç›®ä¸­ç»™å‡º</span>
                        </div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            // æ·»åŠ æ£€æŸ¥å’Œä¸‹ä¸€ç»„æŒ‰é’®
            addGroupControls(container, 'word');
        }

        // æ·»åŠ åˆ†ç»„æ§åˆ¶æŒ‰é’®
        function addGroupControls(container, mode) {
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'flex justify-center space-x-4 mt-8 pt-6 border-t border-gray-200';
            
            // æ£€æŸ¥å½“å‰ç»„æŒ‰é’®
            const checkButton = document.createElement('button');
            checkButton.className = 'px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium';
            checkButton.textContent = 'æ£€æŸ¥å½“å‰ç»„';
            checkButton.onclick = () => checkCurrentGroup(mode);
            
            // ä¸Šä¸€ç»„æŒ‰é’®ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰
            const prevButton = document.createElement('button');
            prevButton.id = `prev-group-${mode}`;
            prevButton.className = 'px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium';
            prevButton.textContent = 'ä¸Šä¸€ç»„';
            prevButton.onclick = () => prevGroup(mode);
            
            // ä¸‹ä¸€ç»„æŒ‰é’®
            const nextButton = document.createElement('button');
            nextButton.className = 'px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium';
            nextButton.id = `next-group-${mode}`;
            
            const group = currentGroupMap[mode] || 0;
            if (group < totalGroups[mode] - 1) {
                nextButton.textContent = 'ä¸‹ä¸€ç»„';
                nextButton.onclick = () => nextGroup(mode);
            } else {
                nextButton.textContent = 'å®Œæˆæ‰€æœ‰é¢˜ç›®';
                nextButton.onclick = () => finishAllQuestions(mode);
            }
            
            controlsDiv.appendChild(checkButton);
            controlsDiv.appendChild(prevButton);
            controlsDiv.appendChild(nextButton);
            container.appendChild(controlsDiv);
        }
        
        // æ£€æŸ¥å½“å‰ç»„ç­”æ¡ˆ
        function checkCurrentGroup(mode) {
            const groupSize = groupSizeMap[mode];
            const group = currentGroupMap[mode] || 0;
            const startIndex = group * groupSize;
            const endIndex = Math.min(startIndex + groupSize, 
                mode === 'oral' ? oralQuestions.length : 
                mode === 'vertical' ? verticalQuestions.length : wordQuestions.length);
            
            // æç¤ºï¼šå»ºè®®åœ¨è‰ç¨¿åŒºå†™å‡ºè®¡ç®—/è§£é¢˜è¿‡ç¨‹ï¼Œä½†ä¸å¼ºåˆ¶é™åˆ¶
            // if (mode !== 'oral' && !hasDraftContent) {
            //     showMessage('å»ºè®®åœ¨è‰ç¨¿åŒºå†™å‡ºè®¡ç®—/è§£é¢˜è¿‡ç¨‹ï¼Œå†æ£€æŸ¥å½“å‰é¢˜ã€‚', 'info');
            // }
            
            let correctCount = 0;
            let totalCount = endIndex - startIndex;
            
            for (let i = startIndex; i < endIndex; i++) {
                const input = document.getElementById(`${mode}-answer-${i}`);
                if (!input) continue;
                
                const userAnswer = input.value.trim();
                let correctAnswer;
                
                if (mode === 'oral') {
                    correctAnswer = oralQuestions[i].answer.toString();
                } else if (mode === 'vertical') {
                    correctAnswer = verticalQuestions[i].answer.toString();
                } else {
                    correctAnswer = wordQuestions[i].answer.toString();
                }
                
                const card = input.closest('.question-card');
                if (userAnswer === correctAnswer) {
                    input.style.borderColor = '#10B981';
                    input.style.backgroundColor = '#ECFDF5';
                    if (card) { card.style.borderColor = '#10B981'; card.style.borderWidth = '2px'; card.style.backgroundColor = '#ECFDF5'; }
                    correctCount++;
                } else {
                    input.style.borderColor = '#EF4444';
                    input.style.backgroundColor = '#FEF2F2';
                    if (card) { card.style.borderColor = '#EF4444'; card.style.borderWidth = '2px'; card.style.backgroundColor = '#FEF2F2'; }
                }
            }
            
            // æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
            showGroupResult(correctCount, totalCount, mode);
        }
        
        // æ˜¾ç¤ºç»„æ£€æŸ¥ç»“æœ
        function showGroupResult(correct, total, mode) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 z-50 border-2';
            
            const percentage = Math.round((correct / total) * 100);
            let borderColor = 'border-red-300';
            let textColor = 'text-red-600';
            let emoji = 'ğŸ˜”';
            
            if (percentage >= 80) {
                borderColor = 'border-green-300';
                textColor = 'text-green-600';
                emoji = 'ğŸ‰';
            } else if (percentage >= 60) {
                borderColor = 'border-yellow-300';
                textColor = 'text-yellow-600';
                emoji = 'ğŸ˜Š';
            }
            
            resultDiv.className += ` ${borderColor}`;
            
            resultDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl mb-4">${emoji}</div>
                    <h3 class="text-xl font-bold mb-2">ç¬¬ ${currentGroup + 1} ç»„æ£€æŸ¥å®Œæˆ</h3>
                    <p class="text-lg ${textColor} mb-4">æ­£ç¡®ç‡: ${correct}/${total} (${percentage}%)</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        ç¡®å®š
                    </button>
                </div>
            `;
            
            document.body.appendChild(resultDiv);
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (resultDiv.parentElement) {
                    resultDiv.remove();
                }
            }, 3000);
        }
        
        // ä¸‹ä¸€ç»„
        function nextGroup(mode) {
            // ä¸å†å¼ºåˆ¶è¦æ±‚è‰ç¨¿åŒºæœ‰å†…å®¹ï¼Œè¡Œä¸ºä¸å£ç®—ä¸€è‡´
            // if (mode !== 'oral' && !hasDraftContent) {
            //     showMessage('å»ºè®®åœ¨è‰ç¨¿åŒºå†™å‡ºè¿‡ç¨‹ï¼Œå†è¿›å…¥ä¸‹ä¸€é¢˜ã€‚', 'info');
            //     return;
            // }
            
            const group = (currentGroupMap[mode] || 0);
            if (group < totalGroups[mode] - 1) {
                currentGroupMap[mode] = group + 1;
                currentGroup = currentGroupMap[mode];
                clearCanvas();
                hasDraftContent = false;
                if (mode === 'oral') {
                    renderOralQuestions();
                } else if (mode === 'vertical') {
                    renderVerticalQuestions();
                } else {
                    renderWordQuestions();
                }
            }
        }

        // ä¸Šä¸€ç»„
        function prevGroup(mode) {
            const group = (currentGroupMap[mode] || 0);
            if (group > 0) {
                currentGroupMap[mode] = group - 1;
                currentGroup = currentGroupMap[mode];
                clearCanvas();
                hasDraftContent = false;
                if (mode === 'oral') {
                    renderOralQuestions();
                } else if (mode === 'vertical') {
                    renderVerticalQuestions();
                } else {
                    renderWordQuestions();
                }
            }
        }
        
        // å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼ˆæœ€åä¸€ç»„è§¦å‘ï¼šç»Ÿä¸€å®¡æ‰¹ã€è¯„åˆ†ã€é”™é¢˜ä¸€æ¬¡é‡åšã€åˆ†é˜¶æ®µæ¨è¿›ï¼‰
        function finishAllQuestions(mode) {
            // ç›´æ¥ä»ç•Œé¢è¯»å–æ¯é¢˜è¾“å…¥ï¼Œç¡®ä¿ä¸å®é™…æ˜¾ç¤ºä¸€è‡´
            const questions = mode === 'oral' ? oralQuestions : mode === 'vertical' ? verticalQuestions : wordQuestions;
            let correctCount = 0;
            const wrongItems = [];
            for (let i = 0; i < questions.length; i++) {
                const input = document.getElementById(`${mode}-answer-${i}`);
                const ua = (input?.value ?? '').toString().trim();
                const ca = questions[i].answer.toString();
                const isCorrect = ua !== '' && ua === ca;
                // åŒæ­¥è§†è§‰åé¦ˆ
                if (input) {
                    const card = input.closest('.question-card');
                    input.style.borderColor = isCorrect ? '#10B981' : '#EF4444';
                    input.style.backgroundColor = isCorrect ? '#ECFDF5' : '#FEF2F2';
                    if (card) {
                        card.style.borderColor = isCorrect ? '#10B981' : '#EF4444';
                        card.style.borderWidth = '2px';
                        card.style.backgroundColor = isCorrect ? '#ECFDF5' : '#FEF2F2';
                    }
                }
                // è®¡åˆ†ä¸é”™é¢˜æ”¶é›†
                if (isCorrect) {
                    correctCount++;
                } else {
                    wrongItems.push({ index: i, question: questions[i].question, correctAnswer: ca });
                }
                // å°†å½“å‰åˆ¤åˆ†åŒæ­¥åˆ°ç”¨æˆ·ç­”æ¡ˆè¡¨ï¼Œé¿å…åç»­çŠ¶æ€ä¸ä¸€è‡´
                recordAnswer(mode, i, ua);
            }
            // è®¡åˆ†ï¼ˆä¸€é¢˜ä¸€åˆ†ï¼‰å¹¶æ›´æ–°æ˜¾ç¤º
            scores[mode] = correctCount;
            const scoreEl = document.getElementById(`${mode}-score`);
            if (scoreEl) scoreEl.textContent = correctCount;
            updateOverallProgress();
            
            // æ˜¾ç¤ºå®¡æ‰¹æ€»ç»“
            showMessage(`${mode === 'oral' ? 'å£ç®—é¢˜' : mode === 'vertical' ? 'ç«–å¼è®¡ç®—' : 'åº”ç”¨é¢˜'}å®¡æ‰¹å®Œæˆï¼š${correctCount}/${questions.length} åˆ†ã€‚${wrongItems.length ? 'æœ‰é”™é¢˜éœ€é‡åšï¼ˆæ¯é¢˜ä¸€æ¬¡æœºä¼šï¼‰ã€‚' : 'å…¨éƒ¨æ­£ç¡®ï¼Œç»§ç»­ä¸‹ä¸€é˜¶æ®µï¼'}`,
                        wrongItems.length ? 'warning' : 'success');
            
            // è‹¥å­˜åœ¨é”™é¢˜ï¼Œè¿›å…¥ä¸€æ¬¡æ€§é‡åš
            if (wrongItems.length) {
                startRedo(mode, wrongItems);
                return;
            }
            
            // æ ‡è®°å½“å‰é¢˜å‹ä¸ºå®ŒæˆçŠ¶æ€
            completionStatus[mode] = true;
            
            // å…¨éƒ¨æ­£ç¡®ï¼Œæ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µæˆ–å®Œæˆ
            currentGroupMap[mode] = 0;
            currentGroup = 0;
            clearCanvas();
            hasDraftContent = false;
            
            // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
            updateProgressIndicator(currentSection);
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¢˜å‹éƒ½å®Œæˆ
            const allCompleted = completionStatus.oral && completionStatus.vertical && completionStatus.word;
            if (allCompleted) {
                // æ‰€æœ‰é˜¶æ®µå®Œæˆ
                showCompletionPage();
                const totalScore = scores.oral + scores.vertical + scores.word;
                const correctRate = totalScore / 50;
                saveCompletionData(correctRate);
            } else {
                // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯ï¼Œä½†ä¸è‡ªåŠ¨è·³è½¬
                showMessage(`${mode === 'oral' ? 'å£ç®—é¢˜' : mode === 'vertical' ? 'ç«–å¼è®¡ç®—' : 'åº”ç”¨é¢˜'}å·²å®Œæˆï¼å¯ä»¥ç‚¹å‡»å…¶ä»–é¢˜å‹ç»§ç»­ç»ƒä¹ ã€‚`, 'success');
            }
        }

        // æ£€æŸ¥å£ç®—ç­”æ¡ˆ
        function checkOralAnswers() {
            let correctCount = 0;
            
            oralQuestions.forEach((q, index) => {
                const input = document.getElementById(`oral-answer-${index}`);
                const userAnswer = parseInt(input.value);
                
                if (userAnswer === q.answer) {
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    wrongAnswers.push({
                        question: q.question,
                        userAnswer: userAnswer,
                        correctAnswer: q.answer,
                        type: 'å£ç®—é¢˜'
                    });
                }
            });
            
            scores.oral = correctCount;
            document.getElementById('oral-score').textContent = correctCount;
            
            if (correctCount >= 16) { // 80%æ­£ç¡®ç‡
                showSuccessMessage('å£ç®—é¢˜å®Œæˆï¼æ­£ç¡®ç‡è¾¾åˆ°80%ä»¥ä¸Šï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€ç¯èŠ‚ï¼');
                setTimeout(() => {
                    showSection('vertical');
                }, 2000);
            } else {
                showMessage(`å£ç®—é¢˜æ­£ç¡®ç‡ä¸è¶³80%ï¼Œè¯·é‡æ–°æ£€æŸ¥é”™é¢˜åå†ç»§ç»­ã€‚æ­£ç¡®é¢˜æ•°ï¼š${correctCount}/20`, 'warning');
            }
            
            updateOverallProgress();
        }

        // æ£€æŸ¥ç«–å¼ç­”æ¡ˆ
        function checkVerticalAnswers() {
            let correctCount = 0;
            
            verticalQuestions.forEach((q, index) => {
                const input = document.getElementById(`vertical-answer-${index}`);
                const userAnswer = parseInt(input.value);
                
                if (userAnswer === q.answer) {
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    wrongAnswers.push({
                        question: q.question,
                        userAnswer: userAnswer,
                        correctAnswer: q.answer,
                        type: 'ç«–å¼è®¡ç®—'
                    });
                }
            });
            
            scores.vertical = correctCount;
            document.getElementById('vertical-score').textContent = correctCount;
            
            if (correctCount >= 12) { // 80%æ­£ç¡®ç‡
                showSuccessMessage('ç«–å¼è®¡ç®—å®Œæˆï¼æ­£ç¡®ç‡è¾¾åˆ°80%ä»¥ä¸Šï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€ç¯èŠ‚ï¼');
                setTimeout(() => {
                    showSection('word');
                }, 2000);
            } else {
                showMessage(`ç«–å¼è®¡ç®—æ­£ç¡®ç‡ä¸è¶³80%ï¼Œè¯·é‡æ–°æ£€æŸ¥é”™é¢˜åå†ç»§ç»­ã€‚æ­£ç¡®é¢˜æ•°ï¼š${correctCount}/15`, 'warning');
            }
            
            updateOverallProgress();
        }

        // æ£€æŸ¥åº”ç”¨é¢˜ç­”æ¡ˆ
        function checkWordAnswers() {
            let correctCount = 0;
            
            wordQuestions.forEach((q, index) => {
                const input = document.getElementById(`word-answer-${index}`);
                const userAnswer = input.value.trim();
                
                if (userAnswer == q.answer || userAnswer === q.answer.toString()) {
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    wrongAnswers.push({
                        question: q.question,
                        userAnswer: userAnswer,
                        correctAnswer: q.answer,
                        type: 'åº”ç”¨é¢˜',
                        solution: q.solution
                    });
                }
            });
            
            scores.word = correctCount;
            document.getElementById('word-score').textContent = correctCount;
            
            const totalScore = scores.oral + scores.vertical + scores.word;
            const correctRate = totalScore / 50;
            
            if (correctRate >= 0.8) {
                showCompletionPage();
                saveCompletionData(correctRate);
            } else {
                showMessage(`åº”ç”¨é¢˜æ­£ç¡®ç‡ä¸è¶³80%ï¼Œè¯·é‡æ–°æ£€æŸ¥é”™é¢˜åå†ç»§ç»­ã€‚æ­£ç¡®é¢˜æ•°ï¼š${correctCount}/15`, 'warning');
            }
            
            updateOverallProgress();
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šé¢˜å‹ï¼ˆæ–°å¢çš„è‡ªç”±åˆ‡æ¢å‡½æ•°ï¼‰
        function switchToSection(section) {
            // æ˜¾ç¤ºæŒ‡å®šéƒ¨åˆ†
            showSection(section);
            // åŒæ­¥å½“å‰ç»„ç´¢å¼•åˆ°å…¼å®¹å˜é‡
            currentGroup = currentGroupMap[section] || 0;
            
            // é‡æ–°æ¸²æŸ“å½“å‰é¢˜å‹çš„é¢˜ç›®
            if (section === 'oral') {
                renderOralQuestions();
            } else if (section === 'vertical') {
                renderVerticalQuestions();
            } else if (section === 'word') {
                renderWordQuestions();
            }
        }

        // æ˜¾ç¤ºæŒ‡å®šéƒ¨åˆ†
        function showSection(section) {
            // ç»Ÿä¸€éšè—æ‰€æœ‰éƒ¨åˆ†ä¸å£ç®—å¤–å±‚å®¹å™¨
            const oralWrapper = document.getElementById('oral-draft-wrapper');
            if (oralWrapper) oralWrapper.classList.add('hidden');
            document.getElementById('oral-section').classList.add('hidden');
            document.getElementById('vertical-section').classList.add('hidden');
            document.getElementById('word-section').classList.add('hidden');
            
            // æ ¹æ®é€‰æ‹©æ˜¾ç¤º
            if (section === 'oral') {
                if (oralWrapper) oralWrapper.classList.remove('hidden');
                document.getElementById('oral-section').classList.remove('hidden');
            } else if (section === 'vertical') {
                document.getElementById('vertical-section').classList.remove('hidden');
            } else if (section === 'word') {
                document.getElementById('word-section').classList.remove('hidden');
            }
            
            // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
            updateProgressIndicator(section);
            
            currentSection = section;
        }

        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator(section) {
            const steps = ['oral', 'vertical', 'word'];
            
            steps.forEach((step) => {
                const stepElement = document.getElementById(step + '-step');
                const circle = stepElement.querySelector('div');
                const text = stepElement.querySelector('span:last-child');
                
                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                stepElement.classList.remove('completed', 'current');
                circle.classList.remove('bg-gray-300', 'bg-green-500', 'bg-blue-500');
                text.classList.remove('text-gray-500', 'text-green-600', 'text-blue-600');
                stepElement.style.border = '';
                
                if (completionStatus[step]) {
                    // å·²å®ŒæˆçŠ¶æ€ï¼šç»¿è‰²è¾¹æ¡†å’Œç»¿è‰²æ ·å¼
                    stepElement.classList.add('completed');
                    stepElement.style.border = '2px solid #10B981';
                    stepElement.style.borderRadius = '8px';
                    circle.classList.add('bg-green-500');
                    text.classList.add('text-green-600');
                } else if (step === section) {
                    // å½“å‰é€‰ä¸­çŠ¶æ€ï¼šè“è‰²æ ·å¼
                    stepElement.classList.add('current');
                    circle.classList.add('bg-blue-500');
                    text.classList.add('text-blue-600');
                } else {
                    // æœªå®ŒæˆçŠ¶æ€ï¼šç°è‰²æ ·å¼
                    circle.classList.add('bg-gray-300');
                    text.classList.add('text-gray-500');
                }
            });
            
            // æ›´æ–°å®Œæˆæ­¥éª¤
            const completeStep = document.getElementById('complete-step');
            const allCompleted = completionStatus.oral && completionStatus.vertical && completionStatus.word;
            if (allCompleted) {
                completeStep.style.border = '2px solid #10B981';
                completeStep.style.borderRadius = '8px';
                const circle = completeStep.querySelector('div');
                const text = completeStep.querySelector('span:last-child');
                circle.classList.remove('bg-gray-300');
                circle.classList.add('bg-green-500');
                text.classList.remove('text-gray-500');
                text.classList.add('text-green-600');
            }
        }

        // æ›´æ–°æ•´ä½“è¿›åº¦
        function updateOverallProgress() {
            const totalQuestions = 50;
            const completedQuestions = scores.oral + scores.vertical + scores.word;
            const progressPercentage = Math.round((completedQuestions / totalQuestions) * 100);
            
            document.getElementById('overall-progress').textContent = `${completedQuestions}/50`;
            document.getElementById('progress-percentage').textContent = `${progressPercentage}%`;
            document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
        }

        // æ˜¾ç¤ºå®Œæˆé¡µé¢
        function showCompletionPage() {
            document.getElementById('oral-section').classList.add('hidden');
            document.getElementById('vertical-section').classList.add('hidden');
            document.getElementById('word-section').classList.add('hidden');
            document.getElementById('completion-page').classList.remove('hidden');
            
            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            document.getElementById('final-oral-score').textContent = scores.oral;
            document.getElementById('final-vertical-score').textContent = scores.vertical;
            document.getElementById('final-word-score').textContent = scores.word;
            document.getElementById('final-total-score').textContent = scores.oral + scores.vertical + scores.word;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            anime({
                targets: '#completion-page > *',
                translateY: [50, 0],
                opacity: [0, 1],
                delay: anime.stagger(100),
                duration: 800,
                easing: 'easeOutQuart'
            });
        }

        // ä¿å­˜å®Œæˆæ•°æ®
        function saveCompletionData(correctRate) {
            const today = new Date().toISOString().split('T')[0];
            const userData = JSON.parse(localStorage.getItem('wangqikai_data') || '{}');
            if (!userData.checkInData) userData.checkInData = {};
            
            userData.checkInData[today] = {
                ...userData.checkInData[today],
                math: {
                    completed: true,
                    time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                    correctRate: correctRate,
                    scores: scores
                }
            };
            
            localStorage.setItem('wangqikai_data', JSON.stringify(userData));
        }

        // æŸ¥çœ‹é”™é¢˜
        function viewWrongAnswers() {
            document.getElementById('wrong-answers').classList.remove('hidden');
            const container = document.getElementById('wrong-questions');
            
            if (wrongAnswers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">ğŸ‰</div>
                        <p class="text-gray-600">å¤ªæ£’äº†ï¼æ²¡æœ‰é”™é¢˜ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = wrongAnswers.map((wa, index) => `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-red-800 mb-2">${wa.type} ${index + 1}</div>
                            <div class="text-red-700 mb-2">é¢˜ç›®: ${wa.question}</div>
                            <div class="text-red-600 mb-2">ä½ çš„ç­”æ¡ˆ: ${wa.userAnswer || 'æœªä½œç­”'}</div>
                            <div class="text-green-600 font-medium">æ­£ç¡®ç­”æ¡ˆ: ${wa.correctAnswer}</div>
                            ${wa.solution ? `<div class="text-blue-600 text-sm mt-2">è§£é¢˜æ€è·¯: ${wa.solution}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // è®°å½•ç­”æ¡ˆ
        function recordAnswer(mode, index, value) {
            if (!userAnswers[mode]) userAnswers[mode] = {};
            userAnswers[mode][index] = (value ?? '').toString().trim();
        }

        // å¼€å§‹é”™é¢˜é‡åšï¼ˆä¸€æ¬¡æœºä¼šï¼‰
        function startRedo(mode, items) {
            redoState = { active: true, mode, items };
            document.getElementById('wrong-answers').classList.remove('hidden');
            const container = document.getElementById('wrong-questions');
            container.innerHTML = `
                <div class="mb-4">
                    <div class="text-lg font-bold text-red-700">${mode === 'oral' ? 'å£ç®—é¢˜' : mode === 'vertical' ? 'ç«–å¼è®¡ç®—' : 'åº”ç”¨é¢˜'}é”™é¢˜é‡åšï¼ˆæ¯é¢˜ä¸€æ¬¡æœºä¼šï¼‰</div>
                    <div class="text-sm text-gray-600">é”™å‡ é¢˜ï¼Œé‡åšå‡ é¢˜ã€‚æäº¤åå°†è‡ªåŠ¨åˆ¤åˆ†å¹¶å†³å®šæ˜¯å¦è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚</div>
                </div>
                ${items.map((it, idx) => `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-3">
                        <div class="font-medium mb-2">ç¬¬ ${it.index + 1} é¢˜ï¼š${it.question}</div>
                        <input type="text" class="answer-input w-32" id="redo-answer-${mode}-${it.index}" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ">
                        <div class="text-sm text-gray-500 mt-1">æ­£ç¡®ç­”æ¡ˆï¼š${it.correctAnswer}</div>
                    </div>
                `).join('')}
                <div class="mt-4 flex items-center space-x-3">
                    <button onclick="submitRedo('${mode}')" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">æäº¤é‡åš</button>
                    <button onclick="document.getElementById('wrong-answers').classList.add('hidden')" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">æš‚ä¸é‡åš</button>
                </div>
            `;
        }

        // æäº¤é‡åšå¹¶æ¨è¿›é˜¶æ®µ
        function submitRedo(mode) {
            if (!redoState.active || redoState.mode !== mode) return;
            const questions = mode === 'oral' ? oralQuestions : mode === 'vertical' ? verticalQuestions : wordQuestions;
            const stillWrong = [];
            let fixedCount = 0;
            for (const it of redoState.items) {
                const input = document.getElementById(`redo-answer-${mode}-${it.index}`);
                const ua = (input?.value ?? '').toString().trim();
                const ca = questions[it.index].answer.toString();
                if (ua !== '' && ua === ca) {
                    fixedCount++;
                    // è®°å½•ä¸ºæœ€ç»ˆç­”æ¡ˆ
                    recordAnswer(mode, it.index, ua);
                } else {
                    stillWrong.push(it);
                }
            }
            // æ›´æ–°åˆ†æ•°
            scores[mode] = scores[mode] + fixedCount;
            const scoreEl = document.getElementById(`${mode}-score`);
            if (scoreEl) scoreEl.textContent = scores[mode];
            updateOverallProgress();
            
            if (stillWrong.length) {
                // ä¸€æ¬¡æœºä¼šå·²ç”¨å®Œï¼Œä¿ç•™é”™é¢˜ï¼Œä¸æ¨è¿›
                showMessage(`ä»æœ‰ ${stillWrong.length} é¢˜æœªæ”¹å¯¹ï¼Œæœ¬æ¬¡é‡åšæœºä¼šå·²ç”¨å®Œã€‚è¯·å¤ä¹ åé‡æ–°å¼€å§‹æœ¬ç¯èŠ‚ã€‚`, 'error');
                return;
            }
            
            // å…¨éƒ¨æ”¹å¯¹ï¼Œæ­å–œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
            document.getElementById('wrong-answers').classList.add('hidden');
            redoState = { active: false, mode: null, items: [] };
            clearCanvas();
            hasDraftContent = false;
            currentGroup = 0;
            if (mode === 'oral') {
                showSuccessMessage('æ­å–œï¼å£ç®—é¢˜å…¨éƒ¨æ”¹å¯¹ï¼Œè¿›å…¥ç«–å¼è®¡ç®—ã€‚');
                showSection('vertical');
            } else if (mode === 'vertical') {
                showSuccessMessage('æ£’ï¼ç«–å¼è®¡ç®—å…¨éƒ¨æ”¹å¯¹ï¼Œè¿›å…¥åº”ç”¨é¢˜ã€‚');
                showSection('word');
            } else {
                showSuccessMessage('ä»Šæ—¥æ•°å­¦æ‰“å¡å®Œæˆï¼');
                showCompletionPage();
                const totalScore = scores.oral + scores.vertical + scores.word;
                const correctRate = totalScore / 50;
                saveCompletionData(correctRate);
            }
        }


        // ç”»å¸ƒç›¸å…³å‡½æ•°
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + '-tool').classList.add('active');
            
            if (tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 20;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = lineWidth;
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            hasDraftContent = true;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                              e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDraftContent = false;
        }

        // ç«–å¼è®¡ç®—è‰ç¨¿åŒºå‡½æ•°
        function setVerticalTool(tool) {
            verticalCurrentTool = tool;
            document.querySelectorAll('#vertical-section .tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('vertical-' + tool + '-tool').classList.add('active');
            
            if (tool === 'eraser') {
                verticalCtx.globalCompositeOperation = 'destination-out';
                verticalCtx.lineWidth = 20;
            } else {
                verticalCtx.globalCompositeOperation = 'source-over';
                verticalCtx.strokeStyle = currentColor;
                verticalCtx.lineWidth = lineWidth;
            }
        }

        function startVerticalDrawing(e) {
            verticalIsDrawing = true;
            const rect = verticalCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            verticalCtx.beginPath();
            verticalCtx.moveTo(x, y);
        }

        function drawVertical(e) {
            if (!verticalIsDrawing) return;
            
            const rect = verticalCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            verticalCtx.lineTo(x, y);
            verticalCtx.stroke();
        }

        function stopVerticalDrawing() {
            verticalIsDrawing = false;
        }

        function handleVerticalTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                              e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            verticalCanvas.dispatchEvent(mouseEvent);
        }

        function clearVerticalCanvas() {
            verticalCtx.clearRect(0, 0, verticalCanvas.width, verticalCanvas.height);
        }

        // åº”ç”¨é¢˜è‰ç¨¿åŒºå‡½æ•°
        function setWordTool(tool) {
            wordCurrentTool = tool;
            document.querySelectorAll('#word-section .tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('word-' + tool + '-tool').classList.add('active');
            
            if (tool === 'eraser') {
                wordCtx.globalCompositeOperation = 'destination-out';
                wordCtx.lineWidth = 20;
            } else {
                wordCtx.globalCompositeOperation = 'source-over';
                wordCtx.strokeStyle = currentColor;
                wordCtx.lineWidth = lineWidth;
            }
        }

        function startWordDrawing(e) {
            wordIsDrawing = true;
            const rect = wordCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            wordCtx.beginPath();
            wordCtx.moveTo(x, y);
        }

        function drawWord(e) {
            if (!wordIsDrawing) return;
            
            const rect = wordCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            wordCtx.lineTo(x, y);
            wordCtx.stroke();
        }

        function stopWordDrawing() {
            wordIsDrawing = false;
        }

        function handleWordTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                              e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            wordCanvas.dispatchEvent(mouseEvent);
        }

        function clearWordCanvas() {
            wordCtx.clearRect(0, 0, wordCanvas.width, wordCanvas.height);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const colors = {
                info: 'bg-blue-100 text-blue-800 border-blue-200',
                success: 'bg-green-100 text-green-800 border-green-200',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                error: 'bg-red-100 text-red-800 border-red-200'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border ${colors[type]} max-w-sm`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            anime({
                targets: messageDiv,
                translateX: [300, 0],
                opacity: [0, 1],
                duration: 300,
                complete: () => {
                    setTimeout(() => {
                        anime({
                            targets: messageDiv,
                            translateX: [0, 300],
                            opacity: [1, 0],
                            duration: 300,
                            complete: () => {
                                document.body.removeChild(messageDiv);
                            }
                        });
                    }, 3000);
                }
            });
        }

        // å¯¼èˆªå‡½æ•°
        function goBack() {
            window.history.back();
        }

        function goHome() {
            window.location.href = 'index.html';
        }
    </script>
<script src="sessions.js"></script>
</body>
</html>

        <!-- OCRæ‹ç…§ä¸é¢˜åº“ç®¡ç†å¼¹çª— -->
        <div id="ocr-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">æ‹ç…§è¯†åˆ«è¯•å·ï¼ˆæ•°å­¦ï¼‰</h3>
                    <button id="close-ocr" class="text-gray-500 hover:text-gray-700">âœ–</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <input id="ocr-file" type="file" accept="image/*" capture="environment" class="w-full" />
                    </div>
                    <div id="ocr-preview" class="hidden">
                        <img id="ocr-img" src="" alt="é¢„è§ˆ" class="max-h-64 mx-auto rounded-lg border" />
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="run-ocr" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">è¯†åˆ«æ–‡å­—</button>
                        <button id="save-ocr" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" disabled>ä¿å­˜åˆ°é¢˜åº“</button>
                        <button id="open-bank" class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">ç®¡ç†é¢˜åº“</button>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">è¯†åˆ«ç»“æœ</label>
                        <textarea id="ocr-text" class="w-full h-40 border rounded-lg p-3" placeholder="è¯†åˆ«çš„æ–‡æœ¬ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>
                    </div>
                    <div id="ocr-status" class="text-sm text-gray-500"></div>
                </div>
            </div>
        </div>
        
        <div id="bank-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">é¢˜åº“ç®¡ç†ï¼ˆæ•°å­¦ï¼‰</h3>
                    <button id="close-bank" class="text-gray-500 hover:text-gray-700">âœ–</button>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center space-x-3">
                        <select id="bank-type" class="border rounded-lg p-2">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="arithmetic">å£ç®—/ç®—å¼</option>
                            <option value="word_problem">åº”ç”¨é¢˜</option>
                            <option value="vertical">ç«–å¼</option>
                            <option value="math_general">å…¶ä»–</option>
                            <option value="24point">24ç‚¹</option>
                        </select>
                        <button id="refresh-bank" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200">åˆ·æ–°</button>
                        <button id="validate-24" class="px-3 py-2 bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200">æ ¡éªŒ24ç‚¹é¢˜åº“</button>
                    </div>
                    <div id="bank-list" class="grid grid-cols-1 gap-3 max-h-[50vh] overflow-auto"></div>
                </div>
            </div>
        </div>

        <!-- ä¾èµ–è„šæœ¬ï¼šTesseract ä¸æ¨¡å— -->
        <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
        <script src="questionBank.js"></script>
        <script src="ocr.js"></script>

        <script>
        // OCRä¸é¢˜åº“äº¤äº’é€»è¾‘ï¼ˆæ•°å­¦ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            const openBtn = document.getElementById('open-ocr');
            const modal = document.getElementById('ocr-modal');
            const closeBtn = document.getElementById('close-ocr');
            const fileInput = document.getElementById('ocr-file');
            const previewBox = document.getElementById('ocr-preview');
            const imgEl = document.getElementById('ocr-img');
            const runBtn = document.getElementById('run-ocr');
            const saveBtn = document.getElementById('save-ocr');
            const bankBtn = document.getElementById('open-bank');
            const textArea = document.getElementById('ocr-text');
            const statusEl = document.getElementById('ocr-status');

            const bankModal = document.getElementById('bank-modal');
            const closeBank = document.getElementById('close-bank');
            const bankType = document.getElementById('bank-type');
            const bankList = document.getElementById('bank-list');
            const refreshBank = document.getElementById('refresh-bank');
            const validate24Btn = document.getElementById('validate-24');

            function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
            function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
            function openBank(){ bankModal.classList.remove('hidden'); bankModal.classList.add('flex'); renderBank(); }
            function closeBankModal(){ bankModal.classList.add('hidden'); bankModal.classList.remove('flex'); }

            openBtn?.addEventListener('click', openModal);
            closeBtn?.addEventListener('click', closeModal);
            bankBtn?.addEventListener('click', openBank);
            closeBank?.addEventListener('click', closeBankModal);

            fileInput?.addEventListener('change', async (e) => {
                const file = e.target.files?.[0];
                if(!file) return;
                const dataUrl = await OCRUtils.readFileAsDataURL(file);
                imgEl.src = dataUrl;
                imgEl.dataset.dataUrl = dataUrl;
                previewBox.classList.remove('hidden');
                saveBtn.disabled = true;
                statusEl.textContent = 'å›¾ç‰‡å·²é€‰æ‹©ï¼Œç‚¹å‡»â€œè¯†åˆ«æ–‡å­—â€ã€‚';
            });

            runBtn?.addEventListener('click', async () => {
                const dataUrl = imgEl.dataset.dataUrl;
                if(!dataUrl){ statusEl.textContent = 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡ã€‚'; return; }
                statusEl.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™â€¦';
                try {
                    const text = await OCRUtils.recognize(dataUrl, 'math');
                    textArea.value = text;
                    saveBtn.disabled = !text.trim();
                    statusEl.textContent = 'è¯†åˆ«å®Œæˆï¼Œå¯ç¼–è¾‘åä¿å­˜åˆ°é¢˜åº“ã€‚';
                } catch(err){
                    console.error(err);
                    statusEl.textContent = 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ›´æ¢æ¸…æ™°å›¾ç‰‡ã€‚';
                }
            });

            saveBtn?.addEventListener('click', () => {
                const text = textArea.value.trim();
                const dataUrl = imgEl.dataset.dataUrl || null;
                if(!text){ statusEl.textContent = 'æ–‡æœ¬ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜ã€‚'; return; }
                const entry = QuestionBank.addEntry({ subject: 'math', imageDataUrl: dataUrl, text });
                statusEl.textContent = 'å·²ä¿å­˜åˆ°é¢˜åº“ï¼ˆç±»å‹ï¼š' + entry.type + 'ï¼‰ã€‚';
                renderBank();
            });

            refreshBank?.addEventListener('click', renderBank);
            validate24Btn?.addEventListener('click', validate24PointBank);
            bankType?.addEventListener('change', renderBank);

            function renderBank(){
                const type = bankType.value || null;
                const items = QuestionBank.list({ subject: 'math', type });
                if(items.length === 0){
                    bankList.innerHTML = '<div class="text-gray-500">æš‚æ— é¢˜ç›®</div>';
                    return;
                }
                bankList.innerHTML = items.map(e => `
                  <div class="border rounded-xl p-3 flex space-x-3">
                    ${e.imageDataUrl ? `<img src="${e.imageDataUrl}" class="w-20 h-20 object-cover rounded">` : ''}
                    <div class="flex-1">
                      <div class="text-sm text-gray-500">ç±»å‹ï¼š${e.type}</div>
                      <textarea data-id="${e.id}" class="w-full border rounded p-2 mt-1">${e.text.replace(/</g,'&lt;')}</textarea>
                      <div class="mt-2 flex space-x-2">
                        <button data-act="update" data-id="${e.id}" class="px-3 py-1 bg-blue-600 text-white rounded">æ›´æ–°</button>
                        <button data-act="delete" data-id="${e.id}" class="px-3 py-1 bg-red-600 text-white rounded">åˆ é™¤</button>
                      </div>
                    </div>
                  </div>
                `).join('');
                bankList.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', (ev) => {
                        const id = btn.getAttribute('data-id');
                        const act = btn.getAttribute('data-act');
                        if(act === 'update'){
                            const ta = bankList.querySelector(`textarea[data-id="${id}"]`);
                            QuestionBank.update(id, { text: ta.value });
                        } else if(act === 'delete'){
                            QuestionBank.remove(id);
                            renderBank();
                        }
                    });
                });
            }
        });
        </script>

<!-- å±å¹•é€‚é…å¼€å…³ï¼ˆå³ä¸Šè§’ï¼‰ -->
<div id="viewport-switcher" class="fixed top-3 right-3 z-50 select-none">
  <div class="relative">
    <button id="adapt-toggle" class="flex items-center space-x-2 px-3 py-2 bg-white/80 backdrop-blur shadow-sm border border-gray-200 rounded-full hover:bg-white">
      <span id="adapt-icon">ğŸ§­</span>
      <span id="adapt-label" class="text-sm">è‡ªé€‚åº”</span>
    </button>
    <div id="adapt-menu" class="absolute right-0 mt-2 w-44 bg-white border border-gray-200 shadow-xl rounded-xl p-2 hidden">
      <button data-adapt="auto" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ§­</span><span>è‡ªåŠ¨è¯†åˆ«</span></button>
      <button data-adapt="desktop" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ’»</span><span>ç”µè„‘ç«¯</span></button>
      <button data-adapt="tablet" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ“Ÿ</span><span>å¹³æ¿ç«¯</span></button>
      <button data-adapt="mobile" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ“±</span><span>æ‰‹æœºç«¯</span></button>
    </div>
  </div>
</div>

<style>
  html[data-adapt="desktop"] body { max-width: 1280px; margin: 0 auto; }
  html[data-adapt="tablet"] body { max-width: 768px; margin: 0 auto; padding-left: 8px; padding-right: 8px; }
  html[data-adapt="mobile"] body { max-width: 390px; margin: 0 auto; padding-left: 12px; padding-right: 12px; }
  body { transition: max-width 0.25s ease; }
</style>
<script>
(function(){
  const root = document.documentElement;
  const KEY = 'adapt-mode';
  function detectMode(){ const w = window.innerWidth; if(w < 640) return 'mobile'; if(w < 1024) return 'tablet'; return 'desktop'; }
  function updateLabel(mode){ const label=document.getElementById('adapt-label'); const icon=document.getElementById('adapt-icon'); if(!label||!icon) return; const map={auto:['è‡ªé€‚åº”','ğŸ§­'],desktop:['ç”µè„‘ç«¯','ğŸ’»'],tablet:['å¹³æ¿ç«¯','ğŸ“Ÿ'],mobile:['æ‰‹æœºç«¯','ğŸ“±']}; const p=map[mode]||map.auto; label.textContent=p[0]; icon.textContent=p[1]; }
  function apply(mode){ if(mode==='auto'){ updateLabel('auto'); return; } root.setAttribute('data-adapt',mode); updateLabel(mode); }
  function init(){ const saved=localStorage.getItem(KEY)||'auto'; apply(saved); if(saved==='auto'){ const setByScreen=()=>{ const m=detectMode(); root.setAttribute('data-adapt',m); }; setByScreen(); window.addEventListener('resize',setByScreen); } }
  document.addEventListener('DOMContentLoaded',()=>{ const toggle=document.getElementById('adapt-toggle'); const menu=document.getElementById('adapt-menu'); if(toggle){ toggle.addEventListener('click',()=>menu.classList.toggle('hidden')); document.addEventListener('click',(e)=>{ if(!menu.contains(e.target) && e.target!==toggle){ menu.classList.add('hidden'); } }); }
    ['auto','desktop','tablet','mobile'].forEach(m=>{ const el=document.querySelector('#adapt-menu [data-adapt="'+m+'"]'); if(!el) return; el.addEventListener('click',()=>{ localStorage.setItem(KEY,m); if(m==='auto'){ updateLabel('auto'); const setByScreen=()=>{ const mm=detectMode(); root.setAttribute('data-adapt',mm); }; setByScreen(); window.addEventListener('resize',setByScreen); } else { root.setAttribute('data-adapt',m); updateLabel(m); window.removeEventListener('resize',()=>{}); } menu.classList.add('hidden'); }); });
    init();
  });
})();
</script>

</body>
</html>
            // 24ç‚¹æ ¡éªŒï¼šè§£æå››ä¸ªç‰Œé¢/æ•°å­—ï¼Œä½¿ç”¨DFSè§£ç®—ï¼Œæ— è§£åˆ™åˆ é™¤
            function validate24PointBank(){
                const items = QuestionBank.list({ subject: 'math' });
                let checked = 0, removed = 0, solvable = 0;
                for(const e of items){
                    const tokens = (e.text.match(/(A|J|Q|K|10|[2-9])/gi) || []).map(x=>x.toUpperCase());
                    if(tokens.length < 4) continue; // é24ç‚¹é¢˜æˆ–ä¸å®Œæ•´
                    const four = tokens.slice(0,4);
                    const nums = four.map(t => {
                        if(t==='A') return 1; if(t==='J'||t==='Q'||t==='K') return 10; return parseInt(t,10);
                    });
                    checked++;
                    const res = find24Solution(nums);
                    if(res){
                        solvable++;
                        // è®°å½•è§£æ³•åˆ°é¢˜åº“æ¡ç›®
                        QuestionBank.update(e.id, { type: '24point', meta: { ...(e.meta||{}), numbers: nums, solutionExpr: res.expr, solvedAt: new Date().toISOString() } });
                    } else {
                        QuestionBank.remove(e.id); removed++;
                    }
                }
                alert(`24ç‚¹é¢˜åº“æ ¡éªŒå®Œæˆï¼šå…±æ£€æµ‹ ${checked} é¢˜ï¼Œä¿ç•™æœ‰è§£ ${solvable} é¢˜ï¼Œåˆ é™¤æ— è§£ ${removed} é¢˜ã€‚`);
                renderBank();
            }

            // å¤ç”¨cardsé¡µçš„DFSæ±‚è§£å™¨ï¼ˆç®€åŒ–ç‰ˆæ‹·è´ï¼‰
            function find24Solution(numbers){
                const EPS = 1e-6;
                function dfs(nums, exprs){
                    if(nums.length === 1){
                        if(Math.abs(nums[0]-24) < EPS){ return { expr: exprs[0], steps: [] }; }
                        return null;
                    }
                    for(let i=0;i<nums.length;i++){
                        for(let j=i+1;j<nums.length;j++){
                            const a=nums[i], b=nums[j];
                            const ea=exprs[i], eb=exprs[j];
                            const restNums=[], restExprs=[];
                            for(let k=0;k<nums.length;k++){
                                if(k!==i && k!==j){ restNums.push(nums[k]); restExprs.push(exprs[k]); }
                            }
                            const candidates=[
                                { val:a+b, expr:`(${ea}+${eb})` },
                                { val:a-b, expr:`(${ea}-${eb})` },
                                { val:b-a, expr:`(${eb}-${ea})` },
                                { val:a*b, expr:`(${ea}*${eb})` }
                            ];
                            if(Math.abs(b)>EPS) candidates.push({ val:a/b, expr:`(${ea}/${eb})` });
                            if(Math.abs(a)>EPS) candidates.push({ val:b/a, expr:`(${eb}/${ea})` });
                            for(const cand of candidates){
                                const nextNums = restNums.concat([cand.val]);
                                const nextExprs = restExprs.concat([cand.expr]);
                                const res = dfs(nextNums, nextExprs);
                                if(res) return res;
                            }
                        }
                    }
                    return null;
                }
                return dfs(numbers, numbers.map(n=>String(n)));
            }