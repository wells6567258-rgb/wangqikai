<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆè¯­æ¥é¾™ - æ±ªçªå‡¯çš„å­¦ä¹ å¤©åœ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js" defer></script>
    <style>
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .idiom-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .idiom-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .idiom-card.current {
            border: 3px solid #F59E0B;
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            transform: scale(1.05);
        }
        
        .chain-link {
            position: relative;
            display: inline-block;
            margin: 0 8px;
        }
        
        .chain-link::after {
            content: 'â†’';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #6B7280;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .chain-link:last-child::after {
            display: none;
        }
        
        .input-field {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            outline: none;
        }
        
        .success-animation {
            animation: bounce 0.6s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .floating-hint {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
        }
        
        .celebration-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body class="tw-theme bg-gradient-to-br from-orange-50 to-yellow-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                        â† è¿”å›
                    </button>
                    <h1 class="text-2xl font-bold text-gray-800">æˆè¯­æ¥é¾™</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        è¿›åº¦: <span class="font-bold text-blue-600" id="progress-text">0/5</span>
                    </div>
                    <button onclick="goHome()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        ä¸»é¡µ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <!-- æ¸¸æˆè¯´æ˜ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">æ¸¸æˆè§„åˆ™</h2>
                    <p class="text-gray-600 mb-4">
                        ç³»ç»Ÿä¼šç»™å‡ºä¸€ä¸ªæˆè¯­ï¼Œä½ éœ€è¦æ¥ä¸€ä¸ªä»¥è¯¥æˆè¯­æœ€åä¸€ä¸ªå­—å¼€å¤´çš„æ–°æˆè¯­ã€‚<br>
                        <span class="text-orange-600 font-medium">æç¤ºï¼šå…è®¸åŒéŸ³ä¸åŒå­—ï¼Œé™ä½éš¾åº¦</span>
                    </p>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                            <span>å·²å®Œæˆ: <span id="completed-count">0</span></span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                            <span>ç›®æ ‡: 5ä¸ªæˆè¯­</span>
                        </div>
                    </div>
                </div>
                
                <!-- è¿›åº¦ç¯ -->
                <div class="relative w-24 h-24">
                    <svg class="progress-ring w-24 h-24" viewBox="0 0 36 36">
                        <path class="progress-ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none" stroke="#E5E7EB" stroke-width="3"/>
                        <path class="progress-ring-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none" stroke="#4A90E2" stroke-width="3" stroke-dasharray="100, 100" stroke-dashoffset="100"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-blue-600" id="progress-percentage">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å½“å‰æˆè¯­å±•ç¤º -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-6">å½“å‰æˆè¯­</h3>
            <div class="flex items-center justify-center mb-6">
                <div class="idiom-card current bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-8 shadow-lg" id="current-idiom">
                    <div class="text-4xl font-bold text-gray-800 mb-2" id="current-idiom-text">ä¸€å¿ƒä¸€æ„</div>
                    <div class="text-lg text-gray-600" id="current-idiom-pinyin">yÄ« xÄ«n yÄ« yÃ¬</div>
                </div>
            </div>
            
            <div class="text-gray-600 mb-4">
                è¯·æ¥ä»¥ <span class="font-bold text-orange-600" id="last-char">æ„</span> å¼€å¤´çš„æˆè¯­
                <span class="text-sm text-gray-500 block mt-1">(æˆ–åŒéŸ³å­— yÃ¬)</span>
            </div>
        </div>

        <!-- æ¥é¾™é“¾å±•ç¤º -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æ¥é¾™é“¾æ¡</h3>
            <div class="flex items-center justify-center flex-wrap" id="idiom-chain">
                <div class="chain-link">
                    <div class="idiom-card bg-blue-100 text-blue-800 px-4 py-2 rounded-lg font-medium">
                        ä¸€å¿ƒä¸€æ„
                    </div>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">è¾“å…¥ä½ çš„ç­”æ¡ˆ</h3>
            <div class="max-w-md mx-auto">
                <input type="text" 
                       class="input-field w-full mb-4" 
                       id="idiom-input" 
                       placeholder="è¯·è¾“å…¥æˆè¯­..."
                       maxlength="4">
                
                <div class="flex items-center justify-center space-x-4 mb-4">
                    <button onclick="submitIdiom()" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        æäº¤
                    </button>
                    <button onclick="getHint()" class="px-8 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium">
                        æç¤º
                    </button>
                    <button onclick="skipIdiom()" class="px-8 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                        è·³è¿‡
                    </button>
                </div>
                
                <div class="text-center">
                    <div class="text-sm text-gray-500 mb-2">è¾“å…¥æ—¶è‡ªåŠ¨æ˜¾ç¤ºæ‹¼éŸ³</div>
                    <div class="text-lg font-medium text-gray-700" id="input-pinyin"></div>
                </div>
            </div>
        </div>

        <!-- æç¤ºé¢æ¿ -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-8 hidden" id="hint-panel">
            <div class="flex items-center">
                <span class="text-yellow-600 mr-2">ğŸ’¡</span>
                <div>
                    <div class="font-medium text-yellow-800">æç¤º</div>
                    <div class="text-yellow-700" id="hint-text"></div>
                </div>
            </div>
        </div>

        <!-- æˆè¯­è§£é‡Šé¢æ¿ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 hidden" id="explanation-panel">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æˆè¯­è§£é‡Š</h3>
            <div class="space-y-4" id="explanation-content">
                <!-- æˆè¯­è§£é‡Šå†…å®¹ -->
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">æ¸¸æˆç»Ÿè®¡</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="total-chains">0</div>
                    <div class="text-sm text-gray-500">æ€»æ¥é¾™æ¬¡æ•°</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="success-rate">0%</div>
                    <div class="text-sm text-gray-500">æˆåŠŸç‡</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="best-chain">0</div>
                    <div class="text-sm text-gray-500">æœ€é•¿æ¥é¾™</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="today-score">0</div>
                    <div class="text-sm text-gray-500">ä»Šæ—¥å¾—åˆ†</div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº†ç¥åŠ¨ç”»å®¹å™¨ -->
    <div class="celebration-particles" id="celebration-container"></div>
    
    <!-- æµ®åŠ¨æç¤º -->
    <div class="floating-hint" id="floating-hint"></div>

    <script>
        // æˆè¯­æ¥é¾™æ¸¸æˆæ ¸å¿ƒé€»è¾‘
        let currentChain = ['ä¸€å¿ƒä¸€æ„'];
        let completedCount = 0;
        let gameStats = {
            totalAttempts: 0,
            successfulChains: 0,
            bestChain: 0,
            todayScore: 0
        };
        
        // æˆè¯­æ•°æ®åº“ï¼ˆä¸‰å¹´çº§æ°´å¹³ï¼‰
        const idiomDatabase = {
            'ä¸€å¿ƒä¸€æ„': {
                pinyin: 'yÄ« xÄ«n yÄ« yÃ¬',
                meaning: 'å½¢å®¹åšäº‹ä¸“å¿ƒä¸€è‡´ï¼Œä¸åˆ†å¿ƒã€‚',
                example: 'ä»–ä¸€å¿ƒä¸€æ„åœ°å­¦ä¹ ï¼Œæˆç»©è¿›æ­¥å¾ˆå¿«ã€‚',
                lastChar: 'æ„',
                lastCharPinyin: 'yÃ¬'
            },
            'æ„æ°”é£å‘': {
                pinyin: 'yÃ¬ qÃ¬ fÄ“ng fÄ',
                meaning: 'å½¢å®¹ç²¾ç¥æŒ¯å¥‹ï¼Œæ°”æ¦‚è±ªè¿ˆã€‚',
                example: 'é’å¹´äººåº”è¯¥æ„æ°”é£å‘ï¼Œå‹‡äºåˆ›æ–°ã€‚',
                lastChar: 'å‘',
                lastCharPinyin: 'fÄ'
            },
            'å‘å¥‹å›¾å¼º': {
                pinyin: 'fÄ fÃ¨n tÃº qiÃ¡ng',
                meaning: 'ä¸‹å®šå†³å¿ƒï¼ŒåŠªåŠ›å˜å¾—å¼ºå¤§ã€‚',
                example: 'æˆ‘ä»¬è¦å‘å¥‹å›¾å¼ºï¼Œä¸ºç¥–å›½å»ºè®¾è´¡çŒ®åŠ›é‡ã€‚',
                lastChar: 'å¼º',
                lastCharPinyin: 'qiÃ¡ng'
            },
            'å¼ºè¯å¤ºç†': {
                pinyin: 'qiÇng cÃ­ duÃ³ lÇ',
                meaning: 'æœ¬æ¥æ²¡æœ‰ç†ï¼Œç¡¬è¯´æˆæœ‰ç†ã€‚',
                example: 'æ˜æ˜æ˜¯ä»–é”™äº†ï¼Œå´è¿˜è¦å¼ºè¯å¤ºç†ã€‚',
                lastChar: 'ç†',
                lastCharPinyin: 'lÇ'
            },
            'ç†ç›´æ°”å£®': {
                pinyin: 'lÇ zhÃ­ qÃ¬ zhuÃ ng',
                meaning: 'ç†ç”±å……åˆ†ï¼Œè¯´è¯å°±æœ‰æ°”åŠ¿ã€‚',
                example: 'ä»–ç†ç›´æ°”å£®åœ°é™ˆè¿°äº†è‡ªå·±çš„è§‚ç‚¹ã€‚',
                lastChar: 'å£®',
                lastCharPinyin: 'zhuÃ ng'
            },
            'å£®å¿—å‡Œäº‘': {
                pinyin: 'zhuÃ ng zhÃ¬ lÃ­ng yÃºn',
                meaning: 'å½¢å®¹ç†æƒ³å®ä¼Ÿè¿œå¤§ã€‚',
                example: 'é’å¹´äººè¦æœ‰å£®å¿—å‡Œäº‘çš„æŠ±è´Ÿã€‚',
                lastChar: 'äº‘',
                lastCharPinyin: 'yÃºn'
            },
            'äº‘å¼€è§æ—¥': {
                pinyin: 'yÃºn kÄi jiÃ n rÃ¬',
                meaning: 'æ¯”å–»é»‘æš—å·²ç»è¿‡å»ï¼Œå…‰æ˜å·²ç»åˆ°æ¥ã€‚',
                example: 'ç»è¿‡åŠªåŠ›ï¼Œç»ˆäºäº‘å¼€è§æ—¥ï¼Œå–å¾—äº†æˆåŠŸã€‚',
                lastChar: 'æ—¥',
                lastCharPinyin: 'rÃ¬'
            },
            'æ—¥æ–°æœˆå¼‚': {
                pinyin: 'rÃ¬ xÄ«n yuÃ¨ yÃ¬',
                meaning: 'å½¢å®¹å‘å±•å˜åŒ–å¾ˆå¿«ï¼Œä¸æ–­å‡ºç°æ–°äº‹ç‰©ã€‚',
                example: 'ç§‘æŠ€å‘å±•æ—¥æ–°æœˆå¼‚ï¼Œæˆ‘ä»¬è¦ä¸æ–­å­¦ä¹ ã€‚',
                lastChar: 'å¼‚',
                lastCharPinyin: 'yÃ¬'
            },
            'å¼‚æƒ³å¤©å¼€': {
                pinyin: 'yÃ¬ xiÇng tiÄn kÄi',
                meaning: 'å½¢å®¹æƒ³æ³•ç¦»å¥‡ï¼Œä¸åˆ‡å®é™…ã€‚',
                example: 'ä»–çš„æƒ³æ³•è™½ç„¶å¼‚æƒ³å¤©å¼€ï¼Œä½†å¾ˆæœ‰åˆ›æ„ã€‚',
                lastChar: 'å¼€',
                lastCharPinyin: 'kÄi'
            },
            'å¼€é—¨è§å±±': {
                pinyin: 'kÄi mÃ©n jiÃ n shÄn',
                meaning: 'æ¯”å–»è¯´è¯ç›´æˆªäº†å½“ï¼Œä¸ç»•å¼¯å­ã€‚',
                example: 'ä»–å¼€é—¨è§å±±åœ°è¯´æ˜äº†æ¥æ„ã€‚',
                lastChar: 'å±±',
                lastCharPinyin: 'shÄn'
            },
            'å±±æ¸…æ°´ç§€': {
                pinyin: 'shÄn qÄ«ng shuÇ xiÃ¹',
                meaning: 'å½¢å®¹é£æ™¯ä¼˜ç¾ã€‚',
                example: 'è¿™é‡Œçš„æ™¯è‰²å±±æ¸…æ°´ç§€ï¼Œä»¤äººæµè¿å¿˜è¿”ã€‚',
                lastChar: 'ç§€',
                lastCharPinyin: 'xiÃ¹'
            },
            'ç§€å¤–æ…§ä¸­': {
                pinyin: 'xiÃ¹ wÃ i huÃ¬ zhÅng',
                meaning: 'å¤–è¡¨ç§€ä¸½ï¼Œå†…å¿ƒèªæ˜ã€‚',
                example: 'å¥¹ç§€å¤–æ…§ä¸­ï¼Œæ˜¯ä¸ªéš¾å¾—çš„äººæ‰ã€‚',
                lastChar: 'ä¸­',
                lastCharPinyin: 'zhÅng'
            },
            'ä¸­æµç ¥æŸ±': {
                pinyin: 'zhÅng liÃº dÇ zhÃ¹',
                meaning: 'æ¯”å–»åšå›ºçš„ã€èƒ½èµ·æ”¯æŸ±ä½œç”¨çš„äººæˆ–é›†ä½“ã€‚',
                example: 'ä»–æ˜¯æˆ‘ä»¬å›¢é˜Ÿçš„ä¸­æµç ¥æŸ±ã€‚',
                lastChar: 'æŸ±',
                lastCharPinyin: 'zhÃ¹'
            },
            'æŸ±çŸ³ä¹‹è‡£': {
                pinyin: 'zhÃ¹ shÃ­ zhÄ« chÃ©n',
                meaning: 'æ¯”å–»æ‹…å½“é‡ä»»çš„å¤§è‡£ã€‚',
                example: 'è¯¸è‘›äº®æ˜¯èœ€å›½çš„æŸ±çŸ³ä¹‹è‡£ã€‚',
                lastChar: 'è‡£',
                lastCharPinyin: 'chÃ©n'
            },
            'è‡£æœå¤©ä¸‹': {
                pinyin: 'chÃ©n fÃº tiÄn xiÃ ',
                meaning: 'ä½¿å¤©ä¸‹äººå½’æœã€‚',
                example: 'ä»¥å¾·æ²»å›½ï¼Œæ–¹èƒ½è‡£æœå¤©ä¸‹ã€‚',
                lastChar: 'ä¸‹',
                lastCharPinyin: 'xiÃ '
            }
        };

        // åŒéŸ³å­—æ˜ å°„
        const homophoneMap = {
            'yÃ¬': ['æ„', 'ä¹‰', 'å¼‚', 'è®®', 'ç›Š'],
            'fÄ': ['å‘', 'æ³•', 'ç½š'],
            'qiÃ¡ng': ['å¼º', 'å¢™', 'æŠ¢'],
            'lÇ': ['ç†', 'é‡Œ', 'ç¤¼', 'æ'],
            'zhuÃ ng': ['å£®', 'çŠ¶', 'æ’'],
            'yÃºn': ['äº‘', 'åŒ€', 'è¿'],
            'rÃ¬': ['æ—¥', 'åŠ›', 'åˆ©'],
            'kÄi': ['å¼€', 'å‡¯', 'æ…¨'],
            'shÄn': ['å±±', 'åˆ ', 'è¡«'],
            'xiÃ¹': ['ç§€', 'ç»£', 'è¢–'],
            'zhÅng': ['ä¸­', 'å¿ ', 'ç»ˆ'],
            'zhÃ¹': ['æŸ±', 'ä½', 'æ³¨'],
            'chÃ©n': ['è‡£', 'è¾°', 'æ™¨'],
            'xiÃ ': ['ä¸‹', 'å¤', 'å“']
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadGameStats();
            updateCurrentIdiom();
            setupEventListeners();
            updateProgress();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const input = document.getElementById('idiom-input');
            
            // è¾“å…¥äº‹ä»¶
            input.addEventListener('input', function() {
                updatePinyinDisplay();
                if (this.value.length === 4) {
                    // è‡ªåŠ¨æäº¤
                    setTimeout(() => {
                        submitIdiom();
                    }, 500);
                }
            });
            
            // å›è½¦é”®æäº¤
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitIdiom();
                }
            });
            
            // ç‚¹å‡»å½“å‰æˆè¯­æ˜¾ç¤ºè§£é‡Š
            document.getElementById('current-idiom').addEventListener('click', function() {
                showIdiomExplanation(currentChain[currentChain.length - 1]);
            });
        }

        // æ›´æ–°å½“å‰æˆè¯­æ˜¾ç¤º
        function updateCurrentIdiom() {
            const currentIdiom = currentChain[currentChain.length - 1];
            const idiomInfo = idiomDatabase[currentIdiom];
            
            if (idiomInfo) {
                document.getElementById('current-idiom-text').textContent = currentIdiom;
                document.getElementById('current-idiom-pinyin').textContent = idiomInfo.pinyin;
                document.getElementById('last-char').textContent = idiomInfo.lastChar;
            }
        }

        // æ›´æ–°æ‹¼éŸ³æ˜¾ç¤º
        function updatePinyinDisplay() {
            const input = document.getElementById('idiom-input');
            const pinyinDisplay = document.getElementById('input-pinyin');
            
            if (input.value.length === 4) {
                // ç®€å•æ‹¼éŸ³è½¬æ¢ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦æ›´å®Œæ•´çš„æ‹¼éŸ³åº“ï¼‰
                const pinyin = convertToPinyin(input.value);
                pinyinDisplay.textContent = pinyin;
            } else {
                pinyinDisplay.textContent = '';
            }
        }

        // ç®€åŒ–çš„æ‹¼éŸ³è½¬æ¢
        function convertToPinyin(chinese) {
            // è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„æ‹¼éŸ³æ˜ å°„ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦å®Œæ•´çš„æ‹¼éŸ³åº“
            const pinyinMap = {
                'ä¸€': 'yÄ«', 'å¿ƒ': 'xÄ«n', 'ä¸€': 'yÄ«', 'æ„': 'yÃ¬',
                'æ„': 'yÃ¬', 'æ°”': 'qÃ¬', 'é£': 'fÄ“ng', 'å‘': 'fÄ',
                'å‘': 'fÄ', 'å¥‹': 'fÃ¨n', 'å›¾': 'tÃº', 'å¼º': 'qiÃ¡ng',
                'å¼º': 'qiÃ¡ng', 'è¯': 'cÃ­', 'å¤º': 'duÃ³', 'ç†': 'lÇ',
                'ç†': 'lÇ', 'ç›´': 'zhÃ­', 'æ°”': 'qÃ¬', 'å£®': 'zhuÃ ng',
                'å£®': 'zhuÃ ng', 'å¿—': 'zhÃ¬', 'å‡Œ': 'lÃ­ng', 'äº‘': 'yÃºn',
                'äº‘': 'yÃºn', 'å¼€': 'kÄi', 'è§': 'jiÃ n', 'æ—¥': 'rÃ¬',
                'æ—¥': 'rÃ¬', 'æ–°': 'xÄ«n', 'æœˆ': 'yuÃ¨', 'å¼‚': 'yÃ¬',
                'å¼‚': 'yÃ¬', 'æƒ³': 'xiÇng', 'å¤©': 'tiÄn', 'å¼€': 'kÄi',
                'å¼€': 'kÄi', 'é—¨': 'mÃ©n', 'è§': 'jiÃ n', 'å±±': 'shÄn',
                'å±±': 'shÄn', 'æ¸…': 'qÄ«ng', 'æ°´': 'shuÇ', 'ç§€': 'xiÃ¹',
                'ç§€': 'xiÃ¹', 'å¤–': 'wÃ i', 'æ…§': 'huÃ¬', 'ä¸­': 'zhÅng',
                'ä¸­': 'zhÅng', 'æµ': 'liÃº', 'ç ¥': 'dÇ', 'æŸ±': 'zhÃ¹',
                'æŸ±': 'zhÃ¹', 'çŸ³': 'shÃ­', 'ä¹‹': 'zhÄ«', 'è‡£': 'chÃ©n',
                'è‡£': 'chÃ©n', 'æœ': 'fÃº', 'å¤©': 'tiÄn', 'ä¸‹': 'xiÃ '
            };
            
            return chinese.split('').map(char => pinyinMap[char] || char).join(' ');
        }

        // æäº¤æˆè¯­
        function submitIdiom() {
            const input = document.getElementById('idiom-input');
            const userInput = input.value.trim();
            
            if (userInput.length !== 4) {
                showMessage('è¯·è¾“å…¥4ä¸ªå­—çš„æˆè¯­ï¼', 'warning');
                return;
            }
            
            gameStats.totalAttempts++;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æˆè¯­
            if (isValidIdiom(userInput)) {
                // æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ¥é¾™è§„åˆ™
                if (isValidChain(userInput)) {
                    addToChain(userInput);
                    gameStats.successfulChains++;
                    gameStats.todayScore += 10;
                    
                    // æˆåŠŸåŠ¨ç”»
                    showSuccessAnimation();
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                    if (currentChain.length - 1 >= 5) {
                        completeGame();
                    }
                } else {
                    showMessage('æˆè¯­ä¸ç¬¦åˆæ¥é¾™è§„åˆ™ï¼Œè¯·é‡æ–°è¾“å…¥ï¼', 'error');
                    showHint();
                }
            } else {
                showMessage('è¿™ä¸ªæˆè¯­ä¸åœ¨æˆ‘ä»¬çš„æ•°æ®åº“ä¸­ï¼Œè¯·è¯•è¯•å…¶ä»–æˆè¯­ï¼', 'error');
                showHint();
            }
            
            updateStats();
            updateProgress();
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æˆè¯­
        function isValidIdiom(idiom) {
            return idiomDatabase[idiom] !== undefined;
        }

        // æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ¥é¾™è§„åˆ™
        function isValidChain(newIdiom) {
            const currentIdiom = currentChain[currentChain.length - 1];
            const currentInfo = idiomDatabase[currentIdiom];
            const newInfo = idiomDatabase[newIdiom];
            
            if (!currentInfo || !newInfo) return false;
            
            // æ£€æŸ¥æœ€åä¸€ä¸ªå­—å’Œç¬¬ä¸€ä¸ªå­—æ˜¯å¦ç›¸åŒæˆ–åŒéŸ³
            const lastChar = currentInfo.lastChar;
            const lastCharPinyin = currentInfo.lastCharPinyin;
            const firstChar = newIdiom[0];
            const firstCharPinyin = newInfo.pinyin.split(' ')[0];
            
            // æ£€æŸ¥åŒéŸ³å­—
            const homophones = homophoneMap[lastCharPinyin] || [];
            
            return firstChar === lastChar || 
                   firstCharPinyin === lastCharPinyin ||
                   homophones.includes(firstChar);
        }

        // æ·»åŠ åˆ°æ¥é¾™é“¾
        function addToChain(idiom) {
            currentChain.push(idiom);
            
            // æ›´æ–°æ¥é¾™é“¾æ˜¾ç¤º
            updateChainDisplay();
            
            // æ›´æ–°å½“å‰æˆè¯­
            updateCurrentIdiom();
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('idiom-input').value = '';
            document.getElementById('input-pinyin').textContent = '';
            
            completedCount++;
        }

        // æ›´æ–°æ¥é¾™é“¾æ˜¾ç¤º
        function updateChainDisplay() {
            const container = document.getElementById('idiom-chain');
            container.innerHTML = '';
            
            currentChain.forEach((idiom, index) => {
                const linkDiv = document.createElement('div');
                linkDiv.className = 'chain-link';
                
                const colorClass = index === currentChain.length - 1 ? 'bg-orange-100 text-orange-800' : 
                                 index >= currentChain.length - 3 ? 'bg-blue-100 text-blue-800' : 
                                 'bg-gray-100 text-gray-800';
                
                linkDiv.innerHTML = `
                    <div class="idiom-card ${colorClass} px-4 py-2 rounded-lg font-medium cursor-pointer"
                         onclick="showIdiomExplanation('${idiom}')">
                        ${idiom}
                    </div>
                `;
                
                container.appendChild(linkDiv);
            });
            
            // æ·»åŠ åŠ¨ç”»
            anime({
                targets: '.chain-link:last-child',
                scale: [0, 1],
                rotateY: [180, 0],
                duration: 600,
                easing: 'easeOutElastic(1, .8)'
            });
        }

        // æ˜¾ç¤ºæˆè¯­è§£é‡Š
        function showIdiomExplanation(idiom) {
            const info = idiomDatabase[idiom];
            if (!info) return;
            
            const panel = document.getElementById('explanation-panel');
            const content = document.getElementById('explanation-content');
            
            content.innerHTML = `
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="text-xl font-bold text-blue-800 mb-2">${idiom}</h4>
                    <div class="text-blue-600 mb-2">${info.pinyin}</div>
                    <div class="text-gray-700 mb-3">
                        <strong>é‡Šä¹‰ï¼š</strong>${info.meaning}
                    </div>
                    <div class="text-gray-600">
                        <strong>ä¾‹å¥ï¼š</strong>${info.example}
                    </div>
                </div>
            `;
            
            panel.classList.remove('hidden');
            
            // æ·»åŠ åŠ¨ç”»
            anime({
                targets: panel,
                opacity: [0, 1],
                translateY: [20, 0],
                duration: 300,
                easing: 'easeOutQuart'
            });
        }

        // è·å–æç¤º
        function getHint() {
            const currentIdiom = currentChain[currentChain.length - 1];
            const currentInfo = idiomDatabase[currentIdiom];
            
            if (!currentInfo) return;
            
            const lastCharPinyin = currentInfo.lastCharPinyin;
            const homophones = homophoneMap[lastCharPinyin] || [];
            
            // æ‰¾åˆ°ä»¥è¿™äº›å­—å¼€å¤´çš„æˆè¯­
            const possibleIdioms = Object.keys(idiomDatabase).filter(idiom => {
                const firstChar = idiom[0];
                return firstChar === currentInfo.lastChar || homophones.includes(firstChar);
            });
            
            if (possibleIdioms.length > 0) {
                const hint = possibleIdioms[Math.floor(Math.random() * possibleIdioms.length)];
                const hintChar = hint[0];
                
                document.getElementById('hint-text').textContent = 
                    `è¯•è¯•ä»¥"${hintChar}"å¼€å¤´çš„æˆè¯­ï¼Œæ¯”å¦‚ï¼š${hint[0]}${hint[1]}${hint[2]}_`;
                document.getElementById('hint-panel').classList.remove('hidden');
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    document.getElementById('hint-panel').classList.add('hidden');
                }, 5000);
            }
        }

        // è·³è¿‡å½“å‰æˆè¯­
        function skipIdiom() {
            // éšæœºé€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªæˆè¯­
            const currentIdiom = currentChain[currentChain.length - 1];
            const currentInfo = idiomDatabase[currentIdiom];
            
            if (!currentInfo) return;
            
            const lastCharPinyin = currentInfo.lastCharPinyin;
            const homophones = homophoneMap[lastCharPinyin] || [];
            
            const possibleIdioms = Object.keys(idiomDatabase).filter(idiom => {
                const firstChar = idiom[0];
                return firstChar === currentInfo.lastChar || homophones.includes(firstChar);
            });
            
            if (possibleIdioms.length > 0) {
                const nextIdiom = possibleIdioms[Math.floor(Math.random() * possibleIdioms.length)];
                addToChain(nextIdiom);
                
                showMessage(`è·³è¿‡æˆåŠŸï¼ç³»ç»Ÿä¸ºä½ é€‰æ‹©äº†ï¼š${nextIdiom}`, 'info');
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                if (currentChain.length - 1 >= 5) {
                    completeGame();
                }
                
                updateStats();
                updateProgress();
            }
        }

        // æ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
        function showSuccessAnimation() {
            // äº”å½©çº¸å±‘æ•ˆæœ
            createConfetti();
            
            // å¡ç‰‡åŠ¨ç”»
            anime({
                targets: '#current-idiom',
                scale: [1, 1.1, 1],
                duration: 600,
                easing: 'easeInOutQuart'
            });
            
            // æˆåŠŸæ¶ˆæ¯
            showMessage('å¤ªæ£’äº†ï¼æ¥é¾™æˆåŠŸï¼+10åˆ†', 'success');
        }

        // åˆ›å»ºäº”å½©çº¸å±‘æ•ˆæœ
        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
            
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.width = '8px';
                confetti.style.height = '8px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = '50%';
                confetti.style.pointerEvents = 'none';
                confetti.style.zIndex = '1000';
                
                document.getElementById('celebration-container').appendChild(confetti);
                
                anime({
                    targets: confetti,
                    translateY: '100vh',
                    translateX: (Math.random() - 0.5) * 200,
                    rotate: Math.random() * 360,
                    duration: Math.random() * 2000 + 1000,
                    easing: 'easeInQuad',
                    complete: () => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }
                });
            }
        }

        // å®Œæˆæ¸¸æˆ
        function completeGame() {
            // ä¿å­˜æ•°æ®
            const today = new Date().toISOString().split('T')[0];
            const userData = JSON.parse(localStorage.getItem('wangqikai_data') || '{}');
            if (!userData.checkInData) userData.checkInData = {};
            
            userData.checkInData[today] = {
                ...userData.checkInData[today],
                chinese: {
                    completed: true,
                    time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                    progress: 5,
                    chain: currentChain,
                    score: gameStats.todayScore
                }
            };
            
            localStorage.setItem('wangqikai_data', JSON.stringify(userData));
            
            // æ˜¾ç¤ºå®ŒæˆåŠ¨ç”»
            showCompletionAnimation();
        }

        // æ˜¾ç¤ºå®ŒæˆåŠ¨ç”»
        function showCompletionAnimation() {
            const completion = document.createElement('div');
            completion.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            completion.innerHTML = `
                <div class="bg-white rounded-2xl p-8 text-center max-w-md mx-4">
                    <div class="text-6xl mb-4">ğŸ†</div>
                    <h2 class="text-3xl font-bold text-green-600 mb-4">æˆè¯­æ¥é¾™å®Œæˆï¼</h2>
                    <p class="text-gray-600 mb-6">æ­å–œä½ æˆåŠŸæ¥é¾™äº†5ä¸ªæˆè¯­ï¼</p>
                    
                    <div class="bg-yellow-50 rounded-lg p-4 mb-6">
                        <div class="text-lg font-bold text-yellow-800 mb-2">ä½ çš„æ¥é¾™é“¾ï¼š</div>
                        <div class="text-sm text-yellow-700">
                            ${currentChain.join(' â†’ ')}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${currentChain.length - 1}</div>
                            <div class="text-sm text-gray-500">æ¥é¾™æˆåŠŸ</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${gameStats.todayScore}</div>
                            <div class="text-sm text-gray-500">è·å¾—åˆ†æ•°</div>
                        </div>
                    </div>
                    
                    <button onclick="goBack()" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        è¿”å›ä¸»é¡µ
                    </button>
                </div>
            `;
            
            document.body.appendChild(completion);
            
            // åº†ç¥åŠ¨ç”»
            createConfetti();
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const progress = (completedCount / 5) * 100;
            const circumference = 2 * Math.PI * 15.9155;
            const offset = circumference - (progress / 100) * circumference;
            
            document.querySelector('.progress-ring-circle').style.strokeDashoffset = offset;
            document.getElementById('progress-percentage').textContent = Math.round(progress) + '%';
            document.getElementById('progress-text').textContent = `${completedCount}/5`;
            document.getElementById('completed-count').textContent = completedCount;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('total-chains').textContent = gameStats.successfulChains;
            
            const successRate = gameStats.totalAttempts > 0 ? 
                Math.round((gameStats.successfulChains / gameStats.totalAttempts) * 100) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
            
            document.getElementById('best-chain').textContent = Math.max(gameStats.bestChain, currentChain.length - 1);
            document.getElementById('today-score').textContent = gameStats.todayScore;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const colors = {
                info: 'bg-blue-100 text-blue-800 border-blue-200',
                success: 'bg-green-100 text-green-800 border-green-200',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                error: 'bg-red-100 text-red-800 border-red-200'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border ${colors[type]} max-w-sm`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            anime({
                targets: messageDiv,
                translateX: [300, 0],
                opacity: [0, 1],
                duration: 300,
                complete: () => {
                    setTimeout(() => {
                        anime({
                            targets: messageDiv,
                            translateX: [0, 300],
                            opacity: [1, 0],
                            duration: 300,
                            complete: () => {
                                document.body.removeChild(messageDiv);
                            }
                        });
                    }, 3000);
                }
            });
        }

        // åŠ è½½æ¸¸æˆç»Ÿè®¡
        function loadGameStats() {
            const stats = JSON.parse(localStorage.getItem('chinese_game_stats') || '{}');
            gameStats = {
                ...gameStats,
                ...stats
            };
            updateStats();
        }

        // ä¿å­˜æ¸¸æˆç»Ÿè®¡
        function saveGameStats() {
            localStorage.setItem('chinese_game_stats', JSON.stringify(gameStats));
        }

        // å¯¼èˆªå‡½æ•°
        function goBack() {
            saveGameStats();
            window.history.back();
        }

        function goHome() {
            saveGameStats();
            window.location.href = 'index.html';
        }
    </script>
<script src="sessions.js"></script>
</body>
</html>


        <!-- OCRæ‹ç…§ä¸é¢˜åº“å¼¹çª—ï¼ˆè¯­æ–‡ï¼‰ -->
        <div id="ocr-modal-cn" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">æ‹ç…§è¯†åˆ«è¯•é¢˜ï¼ˆè¯­æ–‡ï¼‰</h3>
                    <button id="close-ocr-cn" class="text-gray-500 hover:text-gray-700">âœ–</button>
                </div>
                <div class="space-y-4">
                    <input id="ocr-file-cn" type="file" accept="image/*" capture="environment" class="w-full" />
                    <div id="ocr-preview-cn" class="hidden">
                        <img id="ocr-img-cn" src="" alt="é¢„è§ˆ" class="max-h-64 mx-auto rounded-lg border" />
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="run-ocr-cn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">å¼€å§‹è¯†åˆ«</button>
                        <button id="save-ocr-cn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" disabled>ä¿å­˜åˆ°é¢˜åº“</button>
                        <button id="open-bank-cn" class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">ç®¡ç†é¢˜åº“</button>
                    </div>
                    <textarea id="ocr-text-cn" class="w-full h-40 border rounded-lg p-3" placeholder="è¯†åˆ«ç»“æœåœ¨æ­¤æ˜¾ç¤º"></textarea>
                    <div id="ocr-status-cn" class="text-sm text-gray-500"></div>
                </div>
            </div>
        </div>

        <div id="bank-modal-cn" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">é¢˜åº“ç®¡ç†ï¼ˆè¯­æ–‡ï¼‰</h3>
                    <button id="close-bank-cn" class="text-gray-500 hover:text-gray-700">âœ–</button>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center space-x-3">
                        <select id="bank-type-cn" class="border rounded-lg p-2">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="chinese_reading">é˜…è¯»ç†è§£</option>
                            <option value="chinese_general">å…¶ä»–</option>
                        </select>
                        <button id="refresh-bank-cn" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200">åˆ·æ–°</button>
                    </div>
                    <div id="bank-list-cn" class="grid grid-cols-1 gap-3 max-h-[50vh] overflow-auto"></div>
                </div>
            </div>
        </div>

        <!-- ä¾èµ–è„šæœ¬ -->
        <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
        <script src="questionBank.js"></script>
        <script src="ocr.js"></script>
        <script>
        document.addEventListener('DOMContentLoaded', () => {
            const openBtn = document.getElementById('open-ocr-cn');
            const modal = document.getElementById('ocr-modal-cn');
            const closeBtn = document.getElementById('close-ocr-cn');
            const fileInput = document.getElementById('ocr-file-cn');
            const previewBox = document.getElementById('ocr-preview-cn');
            const imgEl = document.getElementById('ocr-img-cn');
            const runBtn = document.getElementById('run-ocr-cn');
            const saveBtn = document.getElementById('save-ocr-cn');
            const bankBtn = document.getElementById('open-bank-cn');
            const textArea = document.getElementById('ocr-text-cn');
            const statusEl = document.getElementById('ocr-status-cn');

            const bankModal = document.getElementById('bank-modal-cn');
            const closeBank = document.getElementById('close-bank-cn');
            const bankType = document.getElementById('bank-type-cn');
            const bankList = document.getElementById('bank-list-cn');
            const refreshBank = document.getElementById('refresh-bank-cn');

            function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
            function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
            function openBank(){ bankModal.classList.remove('hidden'); bankModal.classList.add('flex'); renderBank(); }
            function closeBankModal(){ bankModal.classList.add('hidden'); bankModal.classList.remove('flex'); }

            openBtn?.addEventListener('click', openModal);
            closeBtn?.addEventListener('click', closeModal);
            bankBtn?.addEventListener('click', openBank);
            closeBank?.addEventListener('click', closeBankModal);

            fileInput?.addEventListener('change', async (e) => {
                const file = e.target.files?.[0];
                if(!file) return;
                const dataUrl = await OCRUtils.readFileAsDataURL(file);
                imgEl.src = dataUrl;
                imgEl.dataset.dataUrl = dataUrl;
                previewBox.classList.remove('hidden');
                saveBtn.disabled = true;
                statusEl.textContent = 'å·²é€‰æ‹©å›¾ç‰‡ï¼Œç‚¹å‡»å¼€å§‹è¯†åˆ«';
            });

            runBtn?.addEventListener('click', async () => {
                const dataUrl = imgEl.dataset.dataUrl;
                if(!dataUrl){ statusEl.textContent = 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡'; return; }
                statusEl.textContent = 'æ­£åœ¨è¯†åˆ«â€¦';
                try {
                    const text = await OCRUtils.recognize(dataUrl, 'chinese');
                    textArea.value = text;
                    saveBtn.disabled = !text.trim();
                    statusEl.textContent = 'è¯†åˆ«å®Œæˆï¼Œå¯ç¼–è¾‘åä¿å­˜';
                } catch(err){
                    console.error(err);
                    statusEl.textContent = 'è¯†åˆ«å¤±è´¥ï¼Œè¯·æ›´æ¢æ¸…æ™°å›¾ç‰‡';
                }
            });

            saveBtn?.addEventListener('click', () => {
                const text = textArea.value.trim();
                const dataUrl = imgEl.dataset.dataUrl || null;
                if(!text){ statusEl.textContent = 'æ–‡æœ¬ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜'; return; }
                const entry = QuestionBank.addEntry({ subject: 'chinese', imageDataUrl: dataUrl, text });
                statusEl.textContent = 'å·²ä¿å­˜åˆ°é¢˜åº“ï¼ˆç±»å‹ï¼š' + entry.type + 'ï¼‰';
                renderBank();
            });

            refreshBank?.addEventListener('click', renderBank);
            bankType?.addEventListener('change', renderBank);

            function renderBank(){
                const type = bankType.value || null;
                const items = QuestionBank.list({ subject: 'chinese', type });
                if(items.length === 0){
                    bankList.innerHTML = '<div class="text-gray-500">æš‚æ— æ•°æ®</div>';
                    return;
                }
                bankList.innerHTML = items.map(e => `
                  <div class="border rounded-xl p-3 flex space-x-3">
                    ${e.imageDataUrl ? `<img src="${e.imageDataUrl}" class="w-20 h-20 object-cover rounded">` : ''}
                    <div class="flex-1">
                      <div class="text-sm text-gray-500">ç±»å‹ï¼š${e.type}</div>
                      <textarea data-id="${e.id}" class="w-full border rounded p-2 mt-1">${e.text.replace(/</g,'&lt;')}</textarea>
                      <div class="mt-2 flex space-x-2">
                        <button data-act="update" data-id="${e.id}" class="px-3 py-1 bg-blue-600 text-white rounded">æ›´æ–°</button>
                        <button data-act="delete" data-id="${e.id}" class="px-3 py-1 bg-red-600 text-white rounded">åˆ é™¤</button>
                      </div>
                    </div>
                  </div>
                `).join('');
                bankList.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        const act = btn.getAttribute('data-act');
                        if(act === 'update'){
                            const ta = bankList.querySelector(`textarea[data-id="${id}"]`);
                            QuestionBank.update(id, { text: ta.value });
                        } else if(act === 'delete'){
                            QuestionBank.remove(id);
                            renderBank();
                        }
                    });
                });
            }
        });
        </script>

<!-- å±å¹•é€‚é…å¼€å…³ï¼ˆå³ä¸Šè§’ï¼‰ -->
<div id="viewport-switcher" class="fixed top-3 right-3 z-50 select-none">
  <div class="relative">
    <button id="adapt-toggle" class="flex items-center space-x-2 px-3 py-2 bg-white/80 backdrop-blur shadow-sm border border-gray-200 rounded-full hover:bg-white">
      <span id="adapt-icon">ğŸ§­</span>
      <span id="adapt-label" class="text-sm">è‡ªé€‚åº”</span>
    </button>
    <div id="adapt-menu" class="absolute right-0 mt-2 w-44 bg-white border border-gray-200 shadow-xl rounded-xl p-2 hidden">
      <button data-adapt="auto" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ§­</span><span>è‡ªåŠ¨è¯†åˆ«</span></button>
      <button data-adapt="desktop" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ’»</span><span>ç”µè„‘ç«¯</span></button>
      <button data-adapt="tablet" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ“Ÿ</span><span>å¹³æ¿ç«¯</span></button>
      <button data-adapt="mobile" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center space-x-2"><span>ğŸ“±</span><span>æ‰‹æœºç«¯</span></button>
    </div>
  </div>
</div>

<style>
  html[data-adapt="desktop"] body { max-width: 1280px; margin: 0 auto; }
  html[data-adapt="tablet"] body { max-width: 768px; margin: 0 auto; padding-left: 8px; padding-right: 8px; }
  html[data-adapt="mobile"] body { max-width: 390px; margin: 0 auto; padding-left: 12px; padding-right: 12px; }
  body { transition: max-width 0.25s ease; }
</style>
<script>
(function(){
  const root = document.documentElement;
  const KEY = 'adapt-mode';
  function detectMode(){ const w = window.innerWidth; if(w < 640) return 'mobile'; if(w < 1024) return 'tablet'; return 'desktop'; }
  function updateLabel(mode){ const label=document.getElementById('adapt-label'); const icon=document.getElementById('adapt-icon'); if(!label||!icon) return; const map={auto:['è‡ªé€‚åº”','ğŸ§­'],desktop:['ç”µè„‘ç«¯','ğŸ’»'],tablet:['å¹³æ¿ç«¯','ğŸ“Ÿ'],mobile:['æ‰‹æœºç«¯','ğŸ“±']}; const p=map[mode]||map.auto; label.textContent=p[0]; icon.textContent=p[1]; }
  function apply(mode){ if(mode==='auto'){ updateLabel('auto'); return; } root.setAttribute('data-adapt',mode); updateLabel(mode); }
  function init(){ const saved=localStorage.getItem(KEY)||'auto'; apply(saved); if(saved==='auto'){ const setByScreen=()=>{ const m=detectMode(); root.setAttribute('data-adapt',m); }; setByScreen(); window.addEventListener('resize',setByScreen); } }
  document.addEventListener('DOMContentLoaded',()=>{ const toggle=document.getElementById('adapt-toggle'); const menu=document.getElementById('adapt-menu'); if(toggle){ toggle.addEventListener('click',()=>menu.classList.toggle('hidden')); document.addEventListener('click',(e)=>{ if(!menu.contains(e.target) && e.target!==toggle){ menu.classList.add('hidden'); } }); }
    ['auto','desktop','tablet','mobile'].forEach(m=>{ const el=document.querySelector('#adapt-menu [data-adapt="'+m+'"]'); if(!el) return; el.addEventListener('click',()=>{ localStorage.setItem(KEY,m); if(m==='auto'){ updateLabel('auto'); const setByScreen=()=>{ const mm=detectMode(); root.setAttribute('data-adapt',mm); }; setByScreen(); window.addEventListener('resize',setByScreen); } else { root.setAttribute('data-adapt',m); updateLabel(m); window.removeEventListener('resize',()=>{}); } menu.classList.add('hidden'); }); });
    init();
  });
})();
</script>

</body>
</html>